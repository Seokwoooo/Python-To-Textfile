import time
import logging
import sys
import os
import traceback # traceback import ì¶”ê°€ (ì˜¤ë¥˜ ë¡œê¹…ì— ì‚¬ìš©)
import gspread
import collections
from google.oauth2.service_account import Credentials # gspread ì¸ì¦ì— í•„ìš”

# Selenium ê´€ë ¨ import
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import (
    NoSuchElementException,
    NoSuchWindowException,
    TimeoutException,
    WebDriverException,
    UnexpectedAlertPresentException,
    NoAlertPresentException # Alert ì²˜ë¦¬ì— í•„ìš”
)
from selenium.webdriver.common.keys import Keys # Keys import ì¶”ê°€ (ì‚¬ìš©ëœ ê²½ìš° ëŒ€ë¹„)

# --- ìƒˆë¡œ ë§Œë“  ë¡œê·¸ì¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ import ---
# ì´ import êµ¬ë¬¸ì´ ì‘ë™í•˜ë ¤ë©´ soomgo_login_util.py íŒŒì¼ì´ ë™ì¼ í´ë” ë˜ëŠ” PYTHONPATHì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
from soomgo_login_util import get_soomgo_driver

# --- ë¡œê¹… ì„¤ì • (ì›ë³¸ ìœ ì§€) ---
# íŒŒì¼ í•¸ë“¤ëŸ¬ì™€ ìŠ¤íŠ¸ë¦¼ í•¸ë“¤ëŸ¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ì„¤ì •
logging.basicConfig(
    level=logging.INFO,  # INFO ì´ìƒë§Œ ì¶œë ¥ (DEBUG ì œì™¸)
    format='%(asctime)s [%(levelname)s] %(filename)s:%(lineno)d - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S',
    handlers=[
        # ë¡œê·¸ íŒŒì¼ ê²½ë¡œë¥¼ C:/Soomgo/ í´ë”ë¡œ ì§€ì • (í´ë”ê°€ ì¡´ì¬í•´ì•¼ í•¨)
        logging.FileHandler(r"C:\Soomgo\output_all_invalidNumber.txt", encoding="utf-8"),
        logging.StreamHandler(sys.stdout) # ì½˜ì†” ì¶œë ¥ í•¸ë“¤ëŸ¬
    ]
)
logging.info("--------------------------------------------------------------\n\n")
logging.info("ë™ì¼ì„œë¹„ìŠ¤ê²¬ì (ê°™ì€ì„œë¹„ìŠ¤ì¹´í…Œê³ ë¦¬ê³ ìˆ˜) RPA í”„ë¡œì„¸ìŠ¤ ì‹œì‘")

# --- ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ì›ë³¸ ìœ ì§€) ---
driver = None # WebDriver ê°ì²´, main í•¨ìˆ˜ì—ì„œ ì´ˆê¸°í™”ë¨
global_startCell = 0
global_endCell = 0
global_UpdateSheetCellPos = []
global_UpdateSheetCellText = []

#* Reset Var (ì›ë³¸ ìœ ì§€)
# Title Var
g_Classification      = ""
g_Compensation        = ""
g_Reward              = ""
g_Sec_Classification  = ""
g_Detailed_Reason     = ""
startCell_as_string   = ""
endCell_as_string     = ""

# Display Progress
gd_Status             = ""
gd_Progress_Percent   = ""
gd_ETA                = ""

# Display Result
gd_RPA_Result   = ""
gd_RPA_Detail   = ""
gd_RPA_Error    = ""

#* Cell Row (ì›ë³¸ ìœ ì§€)
cellRow_Classification      = "M"
cellRow_Compensation        = "N"
cellRow_Reward              = "O"
cellRow_Sec_Classification  = "P"
cellRow_Detailed_Reason     = "Q"
cellRow_RPA_Result          = "S"
cellRow_RPA_Detail          = "T"
cellRow_RPA_Error           = "U"
cellRow_Url                 = "E"
cellRow_Report_Date         = "B"
cellRow_Reporter_ID         = "C"

#* Absolute Cell (ì›ë³¸ ìœ ì§€)
absCell_Status              = "M2"
absCell_Progress_Percent    = "O2"
absCell_ETA                 = "Q2"
absCell_StartCell           = "C3"
absCell_EndCell             = "C4"

#* Calculation Var (ì›ë³¸ ìœ ì§€)
saved_Running_Time_List = collections.deque(maxlen=5)
start_Time = 0
# end_Time ë³€ìˆ˜ëŠ” ì‚¬ìš©ë˜ì§€ ì•Šì•„ ì£¼ì„ ì²˜ë¦¬ ë˜ëŠ” ì‚­ì œ ê°€ëŠ¥ (ì›ë³¸ì— ìˆì—ˆìœ¼ë©´ ìœ ì§€)
# end_Time = 0

# --- Google Sheets API ì—°ê²° (ì›ë³¸ ìœ ì§€) ---
logging.info("Google Sheets API ì—°ê²° ì‹œì‘")
# json_key ë³€ìˆ˜ëª… ë° ê²½ë¡œ ì›ë³¸ ìœ ì§€
json_key = "C:/Soomgo/soomgo-lucian-python-8b307b229260.json" # ì‹¤ì œ ê²½ë¡œ í™•ì¸ í•„ìš”
try:
    # scope ë³€ìˆ˜ëª… ë° ë‚´ìš© ì›ë³¸ ìœ ì§€ (í•„ìš”í•œ ê¶Œí•œ í¬í•¨)
    scope = ["https://spreadsheets.google.com/feeds", 'https://www.googleapis.com/auth/spreadsheets',
             "https://www.googleapis.com/auth/drive.file", "https://www.googleapis.com/auth/drive"]
    creds = Credentials.from_service_account_file(json_key, scopes=scope)
    gc = gspread.authorize(creds)

    # sheet_url ë³€ìˆ˜ëª… ë° URL ì›ë³¸ ìœ ì§€
    sheet_url = "https://docs.google.com/spreadsheets/d/113wd2xQ1Vy-XhwdaEbIz4FOca7QFGFzz129rKtycdQE/edit?usp=sharing"
    sheet_key = sheet_url.split('/')[5]
    doc = gc.open_by_key(sheet_key)
    # sheet ë³€ìˆ˜ëª… ë° ì›Œí¬ì‹œíŠ¸ ì´ë¦„ ì›ë³¸ ìœ ì§€
    sheet = doc.worksheet("PRA) Own-Service Reques") # ì›ë³¸ ì›Œí¬ì‹œíŠ¸ ì´ë¦„ ì‚¬ìš©
    logging.info("Google Sheets ì—°ê²° ì™„ë£Œ")
except Exception as e:
    logging.error(f"Google Sheets ì—°ê²° ì‹¤íŒ¨: {e}", exc_info=True)
    logging.error("Google Sheetsì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    sys.exit(1) # ì‹œíŠ¸ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì¢…ë£Œ

# --- Helper Functions (ì›ë³¸ ìœ ì§€ ë° ì¼ë¶€ ìˆ˜ì •) ---

# Unified logging helper (ì›ë³¸ ìœ ì§€)
def loggin(level, message):
    level = level.lower()
    if level == 'info':
        logging.info(message)
    elif level == 'warning':
        logging.warning(message)
    elif level == 'error':
        logging.error(message)
    else:
        logging.debug(message) # ê¸°ë³¸ê°’ì€ debug ë ˆë²¨

# Reset í•¨ìˆ˜ (ì›ë³¸ ìœ ì§€)
def Reset():
    logging.info("Reset í•¨ìˆ˜ ì‹œì‘: ì‹œì‘/ì¢…ë£Œ ì…€ í™•ì¸ ë° ì´ˆê¸°í™”")
    global global_startCell, global_endCell, startCell_as_string, endCell_as_string # ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëª…ì‹œ
    try:
        logging.info("ì‹œíŠ¸ ìƒíƒœ í™•ì¸ ì¤‘...")
        status = sheet.get(absCell_Status)
        startCell = sheet.get(absCell_StartCell)
        endCell = sheet.get(absCell_EndCell)

        status_as_string = "".join(["".join(row) for row in status])
        startCell_as_string = "".join(["".join(row) for row in startCell])
        endCell_as_string = "".join(["".join(row) for row in endCell])

        logging.info(f"í˜„ì¬ ìƒíƒœ: {status_as_string}")
        logging.info(f"ì‹œì‘ ì…€: {startCell_as_string}")
        logging.info(f"ì¢…ë£Œ ì…€: {endCell_as_string}")

        # ìƒíƒœ ì²´í¬ ë¡œì§ ì›ë³¸ ìœ ì§€
        if status_as_string == "RPA Running..":
            loggin('warning', "âš ï¸ Error: ì´ë¯¸ í•´ë‹¹ RPAê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.")
            logging.error("RPAê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘, ì¢…ë£Œí•©ë‹ˆë‹¤.")
            sys.exit(0)
        elif startCell_as_string == "" or startCell_as_string == " ":
            loggin('warning', "âš ï¸ Error: Start Cell ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. Google Sheetì—ì„œ ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
            logging.error("ì‹œì‘ ì…€ì´ ë¹„ì—ˆìŒ, ì¢…ë£Œí•©ë‹ˆë‹¤.")
            sys.exit(0)
        elif endCell_as_string == "" or endCell_as_string == " ":
            loggin('warning', "âš ï¸ Error: End Cell ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. Google Sheetì—ì„œ ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
            logging.error("ì¢…ë£Œ ì…€ì´ ë¹„ì—ˆìŒ, ì¢…ë£Œí•©ë‹ˆë‹¤.")
            sys.exit(0)

        # ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        global_startCell = int(startCell_as_string)
        global_endCell = int(endCell_as_string)

        logging.info(f"ì‹œì‘ ì…€ ë²ˆí˜¸: {global_startCell}")
        logging.info(f"ì¢…ë£Œ ì…€ ë²ˆí˜¸: {global_endCell}")

        # ì‹œì‘ ì…€ ë²”ìœ„ ì²´í¬ ì›ë³¸ ìœ ì§€
        if global_startCell < 7:
            loggin('warning', "âš ï¸ Error: StartCell ê°’ì´ ë³´í˜¸ë²”ìœ„ì¸ 7ë³´ë‹¤ ì‘ìŠµë‹ˆë‹¤. Google Sheetì—ì„œ ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
            logging.error("ì‹œì‘ ì…€ì´ ìµœì†Œê°’ 7ë³´ë‹¤ ì‘ìŒ, ì¢…ë£Œí•©ë‹ˆë‹¤.")
            sys.exit(0)

        logging.info("Reset í•¨ìˆ˜ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ")
    except Exception as e:
        logging.error(f"Reset í•¨ìˆ˜ ì˜¤ë¥˜: {e}", exc_info=True)
        loggin('warning', f"âš ï¸ Reset Error: ì´ˆê¸°í™” ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ. ìƒì„¸ì‚¬ìœ : {e}")
        sys.exit(1)

# ListToString í•¨ìˆ˜ (ì›ë³¸ ìœ ì§€)
def ListToString(cellPos):
    logging.debug(f"ListToString í•¨ìˆ˜ í˜¸ì¶œ: ì…€ {cellPos}ì˜ ê°’ ì½ê¸°") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
    try:
        data = sheet.get(cellPos)
        str_Data = "".join(["".join(row) for row in data])
        logging.debug(f"ì…€ {cellPos}ì˜ ê°’: '{str_Data}'") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
        return str_Data
    except Exception as e:
        logging.error(f"ListToString í•¨ìˆ˜ ì˜¤ë¥˜ (ì…€ {cellPos}): {e}")
        loggin('warning', f"âš ï¸ ListToString Error: ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ. ìƒì„¸ì‚¬ìœ : {e}")
        return "A_Error" # ì˜¤ë¥˜ ë°œìƒ ì‹œ ë°˜í™˜ ê°’

# Calculate_Left_Time í•¨ìˆ˜ (ì›ë³¸ ìœ ì§€)
def Calculate_Left_Time(i):
    logging.debug(f"Calculate_Left_Time í•¨ìˆ˜ í˜¸ì¶œ: í˜„ì¬ ì¸ë±ìŠ¤ {i}") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
    global global_startCell, global_endCell # ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëª…ì‹œ
    try:
        if i == global_endCell:
            logging.info("ë§ˆì§€ë§‰ ì…€ ì²˜ë¦¬ ì™„ë£Œ. ETA ì—…ë°ì´íŠ¸.")
            SavedUpdateSheetValues(absCell_ETA, "âœ… Done!")
            # ìƒíƒœ ë³€ê²½ì€ main í•¨ìˆ˜ ì¢…ë£Œ ì‹œ ì²˜ë¦¬ë˜ë„ë¡ ì—¬ê¸°ì„œ ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬
            # SavedUpdateSheetValues(absCell_Status, "RPA Waiting")
            # SheetUpdatePost(i) # ETA ì—…ë°ì´íŠ¸ëŠ” ë‹¤ë¥¸ ì—…ë°ì´íŠ¸ì™€ í•¨ê»˜ ì²˜ë¦¬ë  ìˆ˜ ìˆìŒ
            return

        # ì´ˆê¸° ë‹¨ê³„ ETA ê³„ì‚° ë¡œì§ ì›ë³¸ ìœ ì§€
        if i < global_startCell + 5:
            logging.info("ì´ˆê¸° ë‹¨ê³„, ì˜ˆìƒ ì‹œê°„ ê³„ì‚° ì¤‘...")
            SavedUpdateSheetValues(absCell_ETA, "âŒ› ê³„ì‚° ì¤‘...")
            return
        else:
            # ê°€ì¤‘ í‰ê·  ê³„ì‚° ë¡œì§ ì›ë³¸ ìœ ì§€
            logging.debug(f"ì‹¤í–‰ ì‹œê°„ ëª©ë¡: {list(saved_Running_Time_List)}") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
            if not saved_Running_Time_List: # ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê³„ì‚° ë¶ˆê°€
                 SavedUpdateSheetValues(absCell_ETA, "âŒ› ê³„ì‚° ì¤‘...")
                 return

            weights = list(range(1, len(saved_Running_Time_List) + 1))
            weighted_sum = sum(t * w for t, w in zip(saved_Running_Time_List, weights))
            total_weights = sum(weights)
            if total_weights == 0: # ê°€ì¤‘ì¹˜ í•©ì´ 0ì´ë©´ ê³„ì‚° ë¶ˆê°€
                SavedUpdateSheetValues(absCell_ETA, "âŒ› ê³„ì‚° ì¤‘...")
                return

            mean = weighted_sum / total_weights
            left_Row = global_endCell - i
            expected_Time = mean * left_Row

            logging.debug(f"ê°€ì¤‘ í‰ê·  ì‹¤í–‰ ì‹œê°„: {mean:.2f}ì´ˆ") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
            logging.debug(f"ë‚¨ì€ í–‰ ìˆ˜: {left_Row}") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
            logging.info(f"ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: {expected_Time:.2f}ì´ˆ")

            # ì‹œê°„ í‘œì‹œ í˜•ì‹ ì›ë³¸ ìœ ì§€
            if expected_Time > 60:
                min_val = expected_Time // 60 # ì •ìˆ˜ ë¶„ ê³„ì‚°
                sec_val = expected_Time % 60 # ë‚˜ë¨¸ì§€ ì´ˆ ê³„ì‚°
            else:
                min_val = 0
                sec_val = expected_Time

            time_text = f"{min_val:.0f}ë¶„ {sec_val:.1f}ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤."
            logging.info(f"ETA ì—…ë°ì´íŠ¸: {time_text}")
            SavedUpdateSheetValues(absCell_ETA, time_text)
    except Exception as e:
        logging.error(f"Calculate_Left_Time í•¨ìˆ˜ ì˜¤ë¥˜: {e}", exc_info=True)
        loggin('warning', f"âš ï¸ Calculate Time Error: ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ. ìƒì„¸ì‚¬ìœ : {e}")
        SavedUpdateSheetValues(absCell_ETA, "âš ï¸ ê³„ì‚° ì˜¤ë¥˜") # ì˜¤ë¥˜ ë°œìƒ ì‹œ ETA í‘œì‹œ

# ErrorNotice í•¨ìˆ˜ (ì›ë³¸ ìœ ì§€)
def ErrorNotice(e, i):
    logging.error(f"ErrorNotice í•¨ìˆ˜ í˜¸ì¶œ: í–‰ {i}ì—ì„œ ì˜¤ë¥˜ ë°œìƒ")
    logging.error(f"ì˜¤ë¥˜ ì •ë³´: {str(e)}")

    # ì˜¤ë¥˜ ë©”ì‹œì§€ ê°€ê³µ ë¡œì§ ì›ë³¸ ìœ ì§€
    ec = " ".join([line.lstrip() for line in str(e).splitlines()])
    logging.info(f"ì‹œíŠ¸ {i}í–‰ì— ì˜¤ë¥˜ í‘œì‹œ ì¤‘...")
    SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "âš ï¸")
    SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", f"{ec}")
    SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", "ì˜¤ë¥˜ë°œìƒ, í•´ë‹¹ ì‹ ê³ ê±´ì€ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.")
    # SheetUpdatePost(i) # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í• ì§€, ëª¨ì•„ì„œ í• ì§€ ê²°ì • (ì›ë³¸ ì½”ë“œ í™•ì¸ í•„ìš”, ì—¬ê¸°ì„œëŠ” ëª¨ìœ¼ëŠ” ë°©ì‹ìœ¼ë¡œ ê°€ì •)
    logging.info(f"í–‰ {i}ì— ì˜¤ë¥˜ í‘œì‹œ ì™„ë£Œ (ì €ì¥ë¨)")

# ContinueNotice í•¨ìˆ˜ (ì›ë³¸ ìœ ì§€)
def ContinueNotice(result, i, service_Element_Text):
    logging.info(f"ContinueNotice í•¨ìˆ˜ í˜¸ì¶œ: í–‰ {i}, ê²°ê³¼ '{result}'")
    # ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€ ì²˜ë¦¬ ì›ë³¸ ìœ ì§€
    if result == "OnlyRequester":
        SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "âœ…")
        SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", "í•´ë‹¹ ê³ ê°ì€ ê³ ìˆ˜ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.")
        SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", "") # ì˜¤ë¥˜ ì—†ìŒ

        SavedUpdateSheetValues(f"{cellRow_Classification}{i}", "ê¸°ì¤€ë¯¸ë‹¬")
        SavedUpdateSheetValues(f"{cellRow_Compensation}{i}", "ê¸°ì¤€ë¯¸ë‹¬")
        SavedUpdateSheetValues(f"{cellRow_Sec_Classification}{i}", "ê¸°ì¤€ë¯¸ë‹¬")

        loggin('info', f"âœ… {i}ë²ˆì§¸: í•´ë‹¹ ê³ ê°ì€ ê³ ìˆ˜ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.")
    elif result == "CorrectRequestPro":
        SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "âœ”ï¸")
        SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", f"ë™ì¼ì„œë¹„ìŠ¤ ìš”ì²­ ê³ ìˆ˜ì…ë‹ˆë‹¤!({service_Element_Text})")
        SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", "") # ì˜¤ë¥˜ ì—†ìŒ
        loggin('info', f"âœ”ï¸ Google Sheet {i}ë²ˆì§¸: ë™ì¼ì„œë¹„ìŠ¤ ìš”ì²­ ê³ ìˆ˜ì…ë‹ˆë‹¤!({service_Element_Text})")
    elif result =="NoPhoneNumber":
        SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "ğŸ“µ")
        SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", "í”¼ì‹ ê³ ì¸ íœ´ëŒ€í°ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¿¼ë¦¬ë¥¼ í†µí•´ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.")
        SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", "") # ì˜¤ë¥˜ ì—†ìŒ
        loggin('info', f"ğŸ“µ Google Sheet {i}ë²ˆì§¸: í”¼ì‹ ê³ ì¸ íœ´ëŒ€í°ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¿¼ë¦¬ë¥¼ í†µí•´ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.")
    else: # ê·¸ ì™¸ ê²½ìš° (ì˜ˆ: íšŒì› ì •ë³´ í™•ì¸ í•„ìš”)
        SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "âš ï¸")
        SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", "íšŒì› ì •ë³´ í™•ì¸ í•„ìš”(íƒˆí‡´ ë“±)")
        SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", "") # ì˜¤ë¥˜ëŠ” ì•„ë‹˜
        loggin('info', f"âš ï¸ Google Sheet {i}ë²ˆì§¸: íšŒì› ì •ë³´ í™•ì¸ í•„ìš”")

    # SheetUpdatePost(i) # ê²°ê³¼ ë°œìƒ ì‹œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í• ì§€, ëª¨ì•„ì„œ í• ì§€ ê²°ì • (ì—¬ê¸°ì„œëŠ” ëª¨ìœ¼ëŠ” ë°©ì‹ìœ¼ë¡œ ê°€ì •)
    logging.info(f"í–‰ {i}ì— ê²°ê³¼ í‘œì‹œ ì™„ë£Œ (ì €ì¥ë¨): {result}")

# SavedUpdateSheetValues í•¨ìˆ˜ (ì›ë³¸ ìœ ì§€)
def SavedUpdateSheetValues(cellPos, text):
    logging.debug(f"SavedUpdateSheetValues í•¨ìˆ˜ í˜¸ì¶œ: ì…€ {cellPos}, ê°’ '{text}'") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
    global global_UpdateSheetCellPos, global_UpdateSheetCellText # ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëª…ì‹œ
    global_UpdateSheetCellPos.append(cellPos)
    global_UpdateSheetCellText.append(text)

# SheetUpdatePost í•¨ìˆ˜ (ì›ë³¸ ìœ ì§€)
def SheetUpdatePost(current_index):
    logging.info(f"SheetUpdatePost í•¨ìˆ˜ í˜¸ì¶œ: í˜„ì¬ ì¸ë±ìŠ¤ {current_index}")
    global global_UpdateSheetCellPos, global_UpdateSheetCellText, start_Time, saved_Running_Time_List # ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëª…ì‹œ

    # ì‹¤í–‰ ì‹œê°„ ê³„ì‚° ë° ì €ì¥ ë¡œì§ ì›ë³¸ ìœ ì§€
    end_time = time.time()
    # start_Timeì´ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if start_Time > 0:
        execution_time = end_time - start_Time
        saved_Running_Time_List.append(execution_time)
        logging.info(f"ì´ë²ˆ í–‰ ì‹¤í–‰ ì‹œê°„: {execution_time:.2f}ì´ˆ")
    else:
        logging.warning("start_Timeì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì‹¤í–‰ ì‹œê°„ì„ ê¸°ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    # ì²« ë²ˆì§¸ í–‰ ì²˜ë¦¬ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ ë¡œì§ ì›ë³¸ ìœ ì§€
    if global_startCell == current_index:
        logging.info("ì²« ë²ˆì§¸ í–‰ ì²˜ë¦¬, RPA ì‹¤í–‰ ì¤‘ ìƒíƒœë¡œ ë³€ê²½")
        SavedUpdateSheetValues(absCell_Status, "RPA Running..") # ì›ë³¸ ìƒíƒœ ë©”ì‹œì§€ ì‚¬ìš©

    try:
        # ì—…ë°ì´íŠ¸ í•  ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸
        if global_UpdateSheetCellPos and global_UpdateSheetCellText:
            logging.info(f"êµ¬ê¸€ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ í•­ëª© ìˆ˜: {len(global_UpdateSheetCellPos)}")

            # batch_update í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ì¤€ë¹„
            updates = []
            for pos, text in zip(global_UpdateSheetCellPos, global_UpdateSheetCellText):
                updates.append({
                    "range": pos,
                    "values": [[str(text)]] # ëª¨ë“  ê°’ì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì•ˆì •ì„± í™•ë³´
                })

            logging.info("sheet.batch_update í˜¸ì¶œ ì¤‘...")
            sheet.batch_update(updates)
            loggin('info', f"âœ… Google Sheet Update ì„±ê³µ. ì—…ë°ì´íŠ¸ ê°œìˆ˜: {len(global_UpdateSheetCellPos)}")

            # ìƒì„¸ ë¡œê·¸ (í•„ìš” ì‹œ DEBUG ë ˆë²¨ë¡œ)
            for pos, text in zip(global_UpdateSheetCellPos, global_UpdateSheetCellText):
                logging.debug(f"ğŸ”ƒ ì—…ë°ì´íŠ¸í•œ ì…€: {pos}, ê°’: {text}")

            logging.info("êµ¬ê¸€ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ")
        else:
            logging.info("êµ¬ê¸€ ì‹œíŠ¸ì— ì—…ë°ì´íŠ¸í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.")

    except Exception as e:
        logging.error(f"SheetUpdatePost ì˜¤ë¥˜: {e}", exc_info=True)
        loggin('warning', f"!!! Sheet Update Post ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        # ì—¬ê¸°ì„œ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€? (ì˜ˆ: ì¬ì‹œë„, ë¡œê¹…ë§Œ ë“±)

    logging.debug("ì—…ë°ì´íŠ¸ ëª©ë¡ ì´ˆê¸°í™”") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
    global_UpdateSheetCellText = []
    global_UpdateSheetCellPos = []

# --- ì¹˜ëª…ì  ì˜ˆì™¸ ì²˜ë¦¬ í•¨ìˆ˜ (ì„¸ì…˜ ë³µêµ¬ ë¡œì§ ì œê±°) ---
# ì´ í•¨ìˆ˜ëŠ” main_task ë˜ëŠ” ë‹¤ë¥¸ í•¨ìˆ˜ì—ì„œ í˜¸ì¶œë˜ê¸° ì „ì— ì •ì˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
def critical_exception(e, context, i):
    global driver # ì „ì—­ driver ê°ì²´ ì‚¬ìš© ëª…ì‹œ
    loggin('warning', f"âš ï¸ critical_exception ë°œìƒ: {context}")
    logging.error(f"ì˜ˆì™¸ ì •ë³´: {str(e)}")
    logging.error(f"ì˜ˆì™¸ íƒ€ì…: {type(e).__name__}")
    logging.error(f"ìƒì„¸ Traceback:\n{traceback.format_exc()}") # ìƒì„¸ traceback ë¡œê¹…

    # ì„¸ì…˜ ë³µêµ¬ ë¡œì§ ì œê±°ë¨
    # if "ì„¸ì…˜ í™•ì¸ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤" in str(e) or "no such session" in str(e).lower() ...

    # ì˜¤ë¥˜ ë°œìƒ ì‹œ ê³µí†µ ì²˜ë¦¬
    logging.error(f"ì¹˜ëª…ì  ì˜¤ë¥˜ë¡œ RPA ì¢…ë£Œ: {context}")
    try:
        # ì˜¤ë¥˜ ìƒíƒœë¥¼ ì‹œíŠ¸ì— ê¸°ë¡ ì‹œë„
        SavedUpdateSheetValues(absCell_Status, "âš ï¸ RPA Error")
        SavedUpdateSheetValues(absCell_ETA, "-")
        ErrorNotice(e, i) # í•´ë‹¹ í–‰ì— ì˜¤ë¥˜ ê¸°ë¡
        SheetUpdatePost(i) # ì €ì¥ëœ ì—…ë°ì´íŠ¸ ì¦‰ì‹œ ì „ì†¡
    except Exception as sheet_update_err:
        logging.error(f"ì˜¤ë¥˜ ìƒíƒœ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì¤‘ ì¶”ê°€ ì˜¤ë¥˜ ë°œìƒ: {sheet_update_err}")

    loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸ {context}ì—ì„œ ì˜ˆì™¸ ë°œìƒí•˜ì—¬ RPA ì¢…ë£Œ: {e}")

    # ë“œë¼ì´ë²„ ì¢…ë£Œ ë° í”„ë¡œê·¸ë¨ ì¢…ë£Œ
    if driver:
        try:
            logging.info("ë“œë¼ì´ë²„ ì¢…ë£Œ ì‹œë„...")
            driver.quit()
            logging.info("ë“œë¼ì´ë²„ ì¢…ë£Œ ì™„ë£Œ.")
        except Exception as quit_err:
            logging.warning(f"ë“œë¼ì´ë²„ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {quit_err}")
    logging.info("í”„ë¡œê·¸ë¨ ì¢…ë£Œ.")
    sys.exit(1) # ì˜¤ë¥˜ ì¢…ë£Œ ìƒíƒœ ì½”ë“œ (0ì´ ì•„ë‹Œ ê°’)

# --- í•µì‹¬ RPA ì‘ì—… ë¡œì§ í•¨ìˆ˜ (main_task) ---
def main_task():
    global driver, start_Time # ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëª…ì‹œ
    logging.info("main_task ì‹œì‘: ì‹ ê³  ê±´ ì²˜ë¦¬ ë£¨í”„ ì§„ì…")
    # ë©”ì¸ ë¡œì§: forë¬¸ì„ í†µí•´ ê° ì‹ ê³  ê±´ì„ ì²˜ë¦¬ (ì›ë³¸ ìœ ì§€)
    for i in range(global_startCell, global_endCell + 1):
        start_Time = time.time() # ê° í–‰ ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
        logging.info(f"===== í–‰ {i} ì²˜ë¦¬ ì‹œì‘ =====")
        try:
            # ì§„í–‰ë¥  ë° ETA ê³„ì‚°
            Calculate_Left_Time(i)
            # ì§„í–‰ë¥  í‘œì‹œ (ì˜ˆì‹œ)
            progress_percent = ((i - global_startCell + 1) / (global_endCell - global_startCell + 1)) * 100
            SavedUpdateSheetValues(absCell_Progress_Percent, f"{progress_percent:.1f}%")

            result = "" # ê²°ê³¼ ë³€ìˆ˜ ì´ˆê¸°í™”
            # Step 1: Force URL ì ‘ì† í›„ Phone Number í¬ë¡¤ë§ (ì›ë³¸ ë¡œì§ ìœ ì§€)
            phoneNumber = ""
            url = ListToString(f"{cellRow_Url}{i}")
            if url == "A_Error":
                # ErrorNoticeëŠ” ListToString ë‚´ë¶€ì—ì„œ í˜¸ì¶œë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ í™•ì¸ í•„ìš”
                # ErrorNotice(url, i) # ì´ë¯¸ ListToStringì—ì„œ ì˜¤ë¥˜ ë¡œê¹… ë° ë°˜í™˜
                logging.error(f"í–‰ {i}: URL ì½ê¸° ì˜¤ë¥˜ ë°œìƒ, ê±´ë„ˆ<0xEB><0><0x8E><0x84>ë‹ˆë‹¤.")
                # ì˜¤ë¥˜ ìƒíƒœ ì—…ë°ì´íŠ¸ëŠ” ErrorNoticeì—ì„œ ì²˜ë¦¬ ê°€ì •
                SheetUpdatePost(i) # ì €ì¥ëœ ì—…ë°ì´íŠ¸ ì „ì†¡
                continue
            if not url.startswith("http"): # ìœ íš¨í•œ URLì¸ì§€ ê°„ë‹¨íˆ í™•ì¸
                 logging.error(f"í–‰ {i}: ìœ íš¨í•˜ì§€ ì•Šì€ URL '{url}', ê±´ë„ˆ<0xEB><0><0x8E><0x84>ë‹ˆë‹¤.")
                 ErrorNotice(f"Invalid URL: {url}", i)
                 SheetUpdatePost(i)
                 continue

            logging.info(f"í–‰ {i}: URL '{url}' ì ‘ì† ì‹œë„")
            driver.get(url)
            # ì›ë³¸ XPath ë° ëŒ€ê¸° ì‹œê°„ ìœ ì§€
            # 'div[2]'ëŠ” ë§¤ìš° ë¶ˆì•ˆì •í•˜ë¯€ë¡œ ì£¼ì˜ (ì›ë³¸ ìœ ì§€ë¥¼ ìœ„í•´ ê·¸ëŒ€ë¡œ ë‘ )
            phone_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[1]/div[1]/div[2]/table/tbody/tr[11]/td[2]'
            elem = WebDriverWait(driver, 20).until(
                EC.presence_of_element_located((By.XPATH, phone_xpath))
            )
            if elem.text != "":
                phoneNumber = elem.text.strip() # ê³µë°± ì œê±° ì¶”ê°€
                logging.info(f"í–‰ {i}: ì „í™”ë²ˆí˜¸ ì¶”ì¶œ ì„±ê³µ - '{phoneNumber}'")
            else:
                result = "NoPhoneNumber"
                logging.info(f"í–‰ {i}: ì „í™”ë²ˆí˜¸ ì—†ìŒ.")
                ContinueNotice(result, i, "")
                SheetUpdatePost(i) # ì €ì¥ëœ ì—…ë°ì´íŠ¸ ì „ì†¡
                continue

        # Step 1 ì˜ˆì™¸ ì²˜ë¦¬ (ì›ë³¸ ìœ ì§€, critical_exception í˜¸ì¶œ ì¶”ê°€)
        except (NoSuchWindowException, WebDriverException) as e:
            logging.error(f"í–‰ {i}: WebDriver ì˜¤ë¥˜ ë°œìƒ (Step 1)")
            critical_exception(e, "Force Phone Number Crawling", i) # ì¹˜ëª…ì  ì˜¤ë¥˜ ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
            # critical_exceptionì—ì„œ sys.exit() í•˜ë¯€ë¡œ ì•„ë˜ ì½”ë“œëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
            # continue
        except Exception as e:
            logging.warning(f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸ Force Phone Number Crawling, ì˜ˆì™¸ ë°œìƒ: {e}")
            ErrorNotice(e, i)
            SheetUpdatePost(i) # ì €ì¥ëœ ì—…ë°ì´íŠ¸ ì „ì†¡
            continue

        # Step 2: ì‹ ê³  ê±´ì˜ ì„œë¹„ìŠ¤ ì¹´í…Œê³ ë¦¬ í¬ë¡¤ë§ (ì›ë³¸ ë¡œì§ ìœ ì§€)
        service_Element_Text = "" # ë³€ìˆ˜ ì´ˆê¸°í™”
        try:
            report_Date = ListToString(f"{cellRow_Report_Date}{i}").strip()
            reporter_ID = ListToString(f"{cellRow_Reporter_ID}{i}").strip()
            loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ ì‹ ê³ ì¼ : {report_Date}")
            loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ ì‹ ê³ ì ì•„ì´ë”” : {reporter_ID}")

            # URL ì¬ì ‘ì† (size íŒŒë¼ë¯¸í„° í¬í•¨)
            url_with_size = f"{url}?size=100" # ì›ë³¸ URL íŒŒë¼ë¯¸í„° ìœ ì§€
            logging.info(f"í–‰ {i}: í”¼ì‹ ê³  ë‚´ì—­ í™•ì¸ ìœ„í•´ '{url_with_size}' ì ‘ì†")
            driver.get(url_with_size)
            time.sleep(2) # < ì›ë³¸ sleep ì‹œê°„ ìœ ì§€ (ë¶ˆê°€í”¼í•˜ë‹¤ë©´ ì´ìœ  ëª…ì‹œ)

            # ì‹ ê³  ë‚´ì—­ í…Œì´ë¸” í–‰ ì°¾ê¸° (ì›ë³¸ XPath ìœ ì§€)
            elements_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr'
            elements = WebDriverWait(driver, 20).until(
                EC.presence_of_all_elements_located((By.XPATH, elements_xpath))
            )
            loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / Force1 í”¼ì‹ ê³ ë‚´ì—­ì—ì„œ [{len(elements)}] ê±´ì˜ ì‹ ê³ ë‚´ì—­ì„ ì°¾ì•„ ì‹ ê³ ê±´ ìˆ˜ë§Œí¼ forë¬¸ ì§„í–‰í•©ë‹ˆë‹¤.")

            # ì‹ ê³ ì¼, ì‹ ê³ ì ID ë§¤ì¹­ ë¡œì§ (ì›ë³¸ ìœ ì§€)
            matching_rows_index = []
            for index in range(1, len(elements) + 1):
                try:
                    # ë‚ ì§œ ì¶”ì¶œ XPath (ì›ë³¸ ìœ ì§€)
                    date_xpath = f'//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr[{index}]/td[8]'
                    full_date_element = WebDriverWait(driver, 10).until( # ëŒ€ê¸° ì‹œê°„ ë‹¨ì¶• ì‹œë„ (ì›ë³¸ 20)
                        EC.presence_of_element_located((By.XPATH, date_xpath))
                    )
                    date_only = full_date_element.text.split(" ")[0]
                    loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ Row {index} ë‚ ì§œ: {date_only}") # ë¡œê·¸ ìƒì„¸í™”
                    if date_only == report_Date:
                        loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ ë‚ ì§œ ì¼ì¹˜ (Row {index})")
                        matching_rows_index.append(index)
                # Step 2 ë‚´ë¶€ ì˜ˆì™¸ ì²˜ë¦¬ (ì›ë³¸ ìœ ì§€, critical_exception í˜¸ì¶œ ì¶”ê°€)
                except (NoSuchWindowException, WebDriverException) as e:
                     logging.error(f"í–‰ {i}, Row {index}: WebDriver ì˜¤ë¥˜ ë°œìƒ (Step 2 - ë‚ ì§œ ì¶”ì¶œ)")
                     critical_exception(e, f"ë‚ ì§œ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ (Row {index})", i)
                except Exception as e:
                    loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸ ë‚ ì§œ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ (Row {index}): {e}")
                    # íŠ¹ì • í–‰ ì˜¤ë¥˜ ì‹œ ì „ì²´ë¥¼ ì¤‘ë‹¨í• ì§€, í•´ë‹¹ í–‰ë§Œ ê±´ë„ˆë›¸ì§€? (ì›ë³¸ í™•ì¸ í•„ìš”, ì—¬ê¸°ì„œëŠ” ê³„ì† ì§„í–‰)

            loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ ë‚ ì§œ ì¼ì¹˜ í–‰ ì¸ë±ìŠ¤: {matching_rows_index}")
            if not matching_rows_index:
                # ì˜¤ë¥˜ ë©”ì‹œì§€ ê°œì„ 
                loggin('error', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / ì‹ ê³ ì¼({report_Date})ê³¼ ì¼ì¹˜í•˜ëŠ” í”¼ì‹ ê³  ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                raise Exception("ì‹ ê³ ì¼ê³¼ ì¼ì¹˜í•˜ëŠ” í”¼ì‹ ê³ ë‚´ì—­ì„ 1ê°œë„ ì°¾ì„ ìˆ˜ ì—†ì–´ ì˜ˆì™¸ë°œìƒ")

            # ì‹ ê³ ì ID í™•ì¸ ë¡œì§ (ì›ë³¸ ìœ ì§€)
            find_Correct_Reportlist_row = -1
            error_occurred_in_id_check = False # ì˜¤ë¥˜ í”Œë˜ê·¸
            for n in matching_rows_index:
                # ë§¤ë²ˆ URL ì¬ì ‘ì†ì€ ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŒ (ì›ë³¸ ìœ ì§€ë¥¼ ìœ„í•´ ê·¸ëŒ€ë¡œ ë‘ )
                logging.info(f"í–‰ {i}, Row {n}: ì‹ ê³ ì ID í™•ì¸ ìœ„í•´ ìƒì„¸ í˜ì´ì§€ ì´ë™ ì‹œë„")
                driver.get(f"{url}?size=100") # ìƒì„¸ ë³´ê¸° ì „ í˜ì´ì§€ë¡œ ëŒì•„ê° (ì›ë³¸ ë¡œì§ ê°€ì •)
                time.sleep(1) # í˜ì´ì§€ ë¡œë“œ ëŒ€ê¸°
                try:
                    # ìƒì„¸ ë³´ê¸° ë²„íŠ¼ XPath (ì›ë³¸ ìœ ì§€, ë™ì  ì¸ë±ìŠ¤ ì²˜ë¦¬)
                    if len(elements) == 1 and index == 1: # ìš”ì†Œê°€ í•˜ë‚˜ì¼ ë•Œ ì¸ë±ìŠ¤ ì—†ì´ ì²˜ë¦¬ (ì›ë³¸ í™•ì¸ í•„ìš”)
                         button_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr/td[3]/a/button'
                    else:
                         button_xpath = f'//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr[{n}]/td[3]/a/button'

                    button = WebDriverWait(driver, 20).until(
                        EC.element_to_be_clickable((By.XPATH, button_xpath))
                    )
                    button.click()
                    logging.info(f"í–‰ {i}, Row {n}: ìƒì„¸ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì„±ê³µ")
                    time.sleep(1) # í˜ì´ì§€ ì „í™˜ ëŒ€ê¸°

                    # íšŒì›ë²ˆí˜¸ ì¶”ì¶œ XPath (ì›ë³¸ ìœ ì§€)
                    id_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[1]/div[1]/div[2]/table/tbody/tr[1]/td[2]'
                    # lambda í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•œ ëŒ€ê¸° (ì›ë³¸ ìœ ì§€)
                    id_text = WebDriverWait(driver, 10).until(
                        lambda d: d.find_element(By.XPATH, id_xpath).text.strip() or False
                    )
                    loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ Force2 ê³ ìˆ˜í˜ì´ì§€ì—ì„œ ê°€ì ¸ì˜¨ íšŒì›ë²ˆí˜¸: {id_text} (Row {n})")
                    if reporter_ID == id_text:
                        find_Correct_Reportlist_row = n
                        logging.info(f"í–‰ {i}: ì‹ ê³ ì ID ì¼ì¹˜! (Row {n})")
                        break # ì¼ì¹˜í•˜ëŠ” í–‰ ì°¾ìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ
                except (NoSuchWindowException, WebDriverException) as e:
                     logging.error(f"í–‰ {i}, Row {n}: WebDriver ì˜¤ë¥˜ ë°œìƒ (Step 2 - ID í™•ì¸)")
                     critical_exception(e, f"ì‹ ê³ ì ID í™•ì¸ ì¤‘ ì˜¤ë¥˜ (Row {n})", i)
                except Exception as e:
                    loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸ ë²„íŠ¼ í´ë¦­ ë˜ëŠ” ID ì¶”ì¶œ ì‹¤íŒ¨ (Row {n}): {e}")
                    error_occurred_in_id_check = True
                    # íŠ¹ì • í–‰ ì˜¤ë¥˜ ì‹œ ì „ì²´ ì¤‘ë‹¨í• ì§€ ê²°ì • (ì›ë³¸ í™•ì¸ í•„ìš”, ì—¬ê¸°ì„œëŠ” ë‹¤ìŒ í–‰ ì‹œë„)
                    # ë§Œì•½ ID í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ í•´ë‹¹ ê±´ ì²˜ë¦¬ë¥¼ ì¤‘ë‹¨í•´ì•¼ í•œë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
                    # break

            # ID í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì²˜ë¦¬ (ì›ë³¸ í™•ì¸ í•„ìš”)
            if error_occurred_in_id_check and find_Correct_Reportlist_row == -1:
                 # ëª¨ë“  í–‰ì—ì„œ ID í™•ì¸ ì‹¤íŒ¨ ì‹œ
                 loggin('error', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / ëª¨ë“  í–‰ì—ì„œ ì‹ ê³ ì ID í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ë˜ëŠ” ë¶ˆì¼ì¹˜.")
                 ErrorNotice("ì‹ ê³ ì ID í™•ì¸ ì‹¤íŒ¨", i)
                 SheetUpdatePost(i)
                 continue

            if find_Correct_Reportlist_row == -1:
                 # ë‚ ì§œëŠ” ë§ì§€ë§Œ IDê°€ ë‹¤ë¥¸ ê²½ìš°
                 loggin('error', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / ì‹ ê³ ì¼ì€ ì¼ì¹˜í•˜ë‚˜ ì‹ ê³ ì ID({reporter_ID})ê°€ ì¼ì¹˜í•˜ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.")
                 ErrorNotice("ì‹ ê³ ì ID ë¶ˆì¼ì¹˜", i)
                 SheetUpdatePost(i)
                 continue

            # ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ (ì›ë³¸ ë¡œì§ ìœ ì§€)
            logging.info(f"í–‰ {i}: ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ ì‹œì‘ (Row {find_Correct_Reportlist_row})")
            driver.get(url) # ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ ì „ í˜ì´ì§€ë¡œ ëŒì•„ê° (ì›ë³¸ ë¡œì§ ê°€ì •)
            time.sleep(1) # í˜ì´ì§€ ë¡œë“œ ëŒ€ê¸°
            row_for_service = find_Correct_Reportlist_row
            # ì„œë¹„ìŠ¤ëª… XPath (ì›ë³¸ ìœ ì§€, ë™ì  ì¸ë±ìŠ¤ ì²˜ë¦¬)
            if len(elements) == 1 and row_for_service == 1: # ìš”ì†Œê°€ í•˜ë‚˜ì¼ ë•Œ ì¸ë±ìŠ¤ ì—†ì´ ì²˜ë¦¬
                 service_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr/td[7]'
            else:
                 service_xpath = f'//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr[{row_for_service}]/td[7]'

            service_Elem = WebDriverWait(driver, 20).until(
                EC.presence_of_element_located((By.XPATH, service_xpath))
            )
            service_Element_Text = service_Elem.text.strip() # ê³µë°± ì œê±° ì¶”ê°€
            loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ force ì„œë¹„ìŠ¤ ì¶”ì¶œ ì™„ë£Œ! ì¶”ì¶œ ê°’: '{service_Element_Text}'")
            time.sleep(3) # ì›ë³¸ sleep ì‹œê°„ ìœ ì§€

        # Step 2 ì˜ˆì™¸ ì²˜ë¦¬ (ì›ë³¸ ìœ ì§€, critical_exception í˜¸ì¶œ ì¶”ê°€)
        except (NoSuchWindowException, WebDriverException) as e:
             logging.error(f"í–‰ {i}: WebDriver ì˜¤ë¥˜ ë°œìƒ (Step 2 - ì„œë¹„ìŠ¤ ì¶”ì¶œ)")
             critical_exception(e, "ì„œë¹„ìŠ¤ ì¹´í…Œê³ ë¦¬ í¬ë¡¤ë§", i)
        except Exception as e:
            loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸ ì„œë¹„ìŠ¤ ì¹´í…Œê³ ë¦¬ í¬ë¡¤ë§ ì˜ˆì™¸: {e}")
            ErrorNotice(e, i)
            SheetUpdatePost(i) # ì €ì¥ëœ ì—…ë°ì´íŠ¸ ì „ì†¡
            continue

        # Step 3: Force1 ì ‘ì† í›„ ê³ ìˆ˜ ì •ë³´ í™•ì¸ (ì›ë³¸ ë¡œì§ ìœ ì§€)
        try:
            # ì‚¬ìš©ì ê²€ìƒ‰ URL (ì›ë³¸ ìœ ì§€)
            url_search = f"https://sgforce.soomgo.com/member/search/simple?search-email=&search-name=&search-phone-num={phoneNumber}&search-is-active=all"
            logging.info(f"í–‰ {i}: ì‚¬ìš©ì ê²€ìƒ‰ URL ì ‘ì†: {url_search}")
            driver.get(url_search)
            # í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ëŒ€ê¸° (ì›ë³¸ ìœ ì§€)
            WebDriverWait(driver, 20).until(lambda d: d.execute_script("return document.readyState") == "complete")

            # ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸” í–‰ ì°¾ê¸° (ì›ë³¸ XPath ìœ ì§€)
            elements_xpath_step3 = '//*[@id="page-wrapper"]/div/div[5]/div/table/tbody/tr'
            # ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ, presence_of_all_elements_located ëŒ€ì‹  find_elements ì‚¬ìš© ê³ ë ¤
            # elements = WebDriverWait(driver, 20).until(
            #     EC.presence_of_all_elements_located((By.XPATH, elements_xpath_step3))
            # )
            # time.sleep(1) # ì ì‹œ ëŒ€ê¸° í›„ find_elements ì‚¬ìš©
            elements = driver.find_elements(By.XPATH, elements_xpath_step3) # ê²°ê³¼ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
            accountCount = len(elements)
            loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @@ ì‚¬ìš©ì ê²€ìƒ‰ ê²°ê³¼: {accountCount} ê±´")

            # ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
            if accountCount == 0:
                 loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / ì „í™”ë²ˆí˜¸ '{phoneNumber}'ì— ëŒ€í•œ ì‚¬ìš©ì ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ.")
                 # ì´ ê²½ìš° ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€? (ì˜ˆ: ì˜¤ë¥˜, íŠ¹ì • ìƒíƒœ ì—…ë°ì´íŠ¸ ë“± - ì›ë³¸ í™•ì¸ í•„ìš”)
                 result = "UserNotFound" # ì„ì˜ì˜ ê²°ê³¼ê°’
                 ContinueNotice(result, i, service_Element_Text) # í˜¹ì€ ErrorNotice
                 SheetUpdatePost(i)
                 continue

            # ê³ ìˆ˜ ì„œë¹„ìŠ¤ ëª©ë¡ ì¶”ì¶œ ë¡œì§ (ì›ë³¸ ìœ ì§€)
            proServiceList = []
            # XPath ì¸ë±ìŠ¤ëŠ” 1ë¶€í„° ì‹œì‘, elements ë¦¬ìŠ¤íŠ¸ëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ ì£¼ì˜
            # ì›ë³¸ ì½”ë“œëŠ” ì¸ë±ìŠ¤ë¥¼ 2ë¶€í„° ì‹œì‘í–ˆìœ¼ë¯€ë¡œ, ì²« ë²ˆì§¸ í–‰(tr[1])ì€ í—¤ë”ì¼ ìˆ˜ ìˆìŒ (í™•ì¸ í•„ìš”)
            # ì›ë³¸ ë¡œì§ì„ ë”°ë¼ 2ë¶€í„° ì‹œì‘ (ac ë³€ìˆ˜)
            for ac_index in range(1, accountCount): # 0ë²ˆ ì¸ë±ìŠ¤(tr[1]) ê±´ë„ˆë›°ê³  1ë²ˆë¶€í„°(tr[2]) ì‹œì‘
                ac = ac_index + 1 # XPath ì¸ë±ìŠ¤ (2ë¶€í„° ì‹œì‘)
                try:
                    # ì‚¬ìš©ì ìœ í˜• í™•ì¸ (ì›ë³¸ XPath ìœ ì§€)
                    userType_xpath = f'//*[@id="page-wrapper"]/div/div[5]/div/table/tbody/tr[{ac}]/td[3]'
                    userType = WebDriverWait(driver, 5).until(
                        EC.presence_of_element_located((By.XPATH, userType_xpath))
                    )
                    userTypeText = userType.text.strip()
                    loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @@@ Row Index {ac_index} (XPath tr[{ac}]): ì‚¬ìš©ì ìœ í˜• '{userTypeText}'")

                    if userTypeText == "ìš”ì²­ì":
                        loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @@@ Row Index {ac_index}ëŠ” ìš”ì²­ì => pass")
                        continue
                    elif userTypeText == "ê³ ìˆ˜":
                        loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @@@ Row Index {ac_index}ëŠ” ê³ ìˆ˜ => ìƒì„¸ ì •ë³´ í™•ì¸")
                        # íŒì—… ë²„íŠ¼ í´ë¦­ (ì›ë³¸ XPath ìœ ì§€)
                        # í´ë¦­í•  ìš”ì†ŒëŠ” í–‰ ì „ì²´(tr)ì¼ ìˆ˜ ìˆìŒ (ì›ë³¸ í™•ì¸ í•„ìš”)
                        popup_element_xpath = f'//*[@id="page-wrapper"]/div/div[5]/div/table/tbody/tr[{ac}]'
                        popupButton = WebDriverWait(driver, 5).until(
                            EC.element_to_be_clickable((By.XPATH, popup_element_xpath)) # í´ë¦­ ê°€ëŠ¥í•  ë•Œê¹Œì§€ ëŒ€ê¸°
                        )
                        popupButton.click()
                        time.sleep(0.5) # íŒì—… ë¡œë“œ ëŒ€ê¸°

                        # ì„œë¹„ìŠ¤ ëª©ë¡ ì¶”ì¶œ (ì›ë³¸ XPath ìœ ì§€)
                        service_xpath_popup = '//*[@id="summery-modal-form"]/div[2]/dl/dd[7]'
                        service = WebDriverWait(driver, 5).until(
                            EC.presence_of_element_located((By.XPATH, service_xpath_popup))
                        )
                        service_text = service.text.strip()
                        if service_text:
                            proServiceList.append(service_text)
                            loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @@@ Row Index {ac_index} ê³ ìˆ˜ ì„œë¹„ìŠ¤: '{service_text}'")
                        else:
                            loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @@@ Row Index {ac_index} ê³ ìˆ˜ ì„œë¹„ìŠ¤ ì •ë³´ ì—†ìŒ.")

                        # íŒì—… ë‹«ê¸° ë²„íŠ¼ í´ë¦­ (ì›ë³¸ XPath ìœ ì§€)
                        closebutton_xpath = '//*[@id="summery-modal-form"]/div[1]/button'
                        closebutton = WebDriverWait(driver, 5).until(
                            EC.element_to_be_clickable((By.XPATH, closebutton_xpath))
                        )
                        closebutton.click()
                        time.sleep(0.5) # íŒì—… ë‹«í˜ ëŒ€ê¸°
                    else:
                        # ì˜ˆìƒì¹˜ ëª»í•œ ì‚¬ìš©ì ìœ í˜• ì²˜ë¦¬
                        loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @@@ Row Index {ac_index}: ì˜ˆìƒì¹˜ ëª»í•œ ì‚¬ìš©ì ìœ í˜• '{userTypeText}'")

                # Step 3 ë‚´ë¶€ ë£¨í”„ ì˜ˆì™¸ ì²˜ë¦¬ (ì›ë³¸ ìœ ì§€, ì˜¤ë¥˜ ë°œìƒ ì‹œ ë‹¤ìŒ í–‰ ì²˜ë¦¬)
                except (NoSuchElementException, TimeoutException) as inner_loop_err:
                     # íŒì—… ë‹«ê¸° ì‹œë„ (ì˜¤ë¥˜ ë°œìƒ ì‹œ íŒì—…ì´ ì—´ë ¤ìˆì„ ìˆ˜ ìˆìŒ)
                     try:
                         closebutton_xpath = '//*[@id="summery-modal-form"]/div[1]/button'
                         # ëŒ€ê¸° ì‹œê°„ ì—†ì´ ì¦‰ì‹œ ì°¾ê¸° ì‹œë„
                         closebutton = driver.find_element(By.XPATH, closebutton_xpath)
                         if closebutton.is_displayed():
                              closebutton.click()
                              time.sleep(0.5)
                     except Exception:
                         pass # ë‹«ê¸° ë²„íŠ¼ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ì‹œ ë¬´ì‹œ
                     loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / !! Row Index {ac_index} ê³ ìˆ˜ ì •ë³´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {inner_loop_err}")
                     # í•´ë‹¹ ê³ ìˆ˜ ì •ë³´ëŠ” ê±´ë„ˆë›°ê³  ë‹¤ìŒ í–‰ ì²˜ë¦¬
                     continue
                # Step 3 ë‚´ë¶€ ë£¨í”„ WebDriver ì˜ˆì™¸ ì²˜ë¦¬ (ì¹˜ëª…ì  ì˜¤ë¥˜)
                except (NoSuchWindowException, WebDriverException) as e:
                     logging.error(f"í–‰ {i}, Row Index {ac_index}: WebDriver ì˜¤ë¥˜ ë°œìƒ (Step 3 - ê³ ìˆ˜ ì •ë³´)")
                     critical_exception(e, f"ê³ ìˆ˜ ì •ë³´ í™•ì¸ ì¤‘ ì˜¤ë¥˜ (Row Index {ac_index})", i)
                # Step 3 ë‚´ë¶€ ë£¨í”„ ê¸°íƒ€ ì˜ˆì™¸ ì²˜ë¦¬
                except Exception as e:
                     # íŒì—… ë‹«ê¸° ì‹œë„
                     try:
                         closebutton_xpath = '//*[@id="summery-modal-form"]/div[1]/button'
                         closebutton = driver.find_element(By.XPATH, closebutton_xpath)
                         if closebutton.is_displayed():
                              closebutton.click()
                              time.sleep(0.5)
                     except Exception:
                         pass
                     # ErrorNotice(f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / !! Row {ac_index} ê³ ìˆ˜ ì •ë³´ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸: {e}", i) # ì˜¤ë¥˜ ëˆ„ì ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬
                     loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / !! Row Index {ac_index} ê³ ìˆ˜ ì •ë³´ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸: {e}")
                     continue # ë‹¤ìŒ í–‰ ì²˜ë¦¬

            # ì¶”ì¶œëœ ê³ ìˆ˜ ì„œë¹„ìŠ¤ì™€ ì‹ ê³ ëœ ì„œë¹„ìŠ¤ ë¹„êµ (ì›ë³¸ ë¡œì§ ìœ ì§€)
            loggin('info', f"í–‰ {i}: ì¶”ì¶œëœ ê³ ìˆ˜ ì„œë¹„ìŠ¤ ëª©ë¡: {proServiceList}")
            loggin('info', f"í–‰ {i}: ë¹„êµí•  ì‹ ê³  ì„œë¹„ìŠ¤: '{service_Element_Text}'")
            match_found = False # ì¼ì¹˜ ì—¬ë¶€ í”Œë˜ê·¸
            for psl in proServiceList:
                # ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì„œë¹„ìŠ¤ ëª©ë¡ ì²˜ë¦¬ (ì›ë³¸ ìœ ì§€)
                for each_service in [item.strip() for item in psl.split(',')]:
                    loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / ğŸ” ë¹„êµ: '{each_service}' vs '{service_Element_Text}'")
                    # loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / ğŸ” ê¸¸ì´ ë¹„êµ: {len(each_service)} vs {len(service_Element_Text)}") # ê¸¸ì´ ë¹„êµëŠ” ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìŒ
                    if each_service == service_Element_Text:
                        result = "CorrectRequestPro"
                        loggin('info', f"í–‰ {i}: ë™ì¼ ì„œë¹„ìŠ¤ ë°œê²¬!")
                        ContinueNotice(result, i, service_Element_Text)
                        match_found = True
                        break # ë‚´ë¶€ ë£¨í”„ ì¢…ë£Œ
                if match_found:
                    break # ì™¸ë¶€ ë£¨í”„ ì¢…ë£Œ

            # ì¼ì¹˜í•˜ëŠ” ì„œë¹„ìŠ¤ê°€ ì—†ì—ˆì„ ê²½ìš° ì²˜ë¦¬ (ì›ë³¸ ë¡œì§ ìœ ì§€)
            if not match_found:
                result = "OnlyRequester" # ë˜ëŠ” "DifferentServicePro" ë“± ìƒíƒœ ì„¸ë¶„í™” ê°€ëŠ¥
                loggin('info', f"í–‰ {i}: ë™ì¼ ì„œë¹„ìŠ¤ ì—†ìŒ. ê²°ê³¼: {result}")
                ContinueNotice(result, i, service_Element_Text) # ì„œë¹„ìŠ¤ í…ìŠ¤íŠ¸ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œ ì „ë‹¬

        # Step 3 ì˜ˆì™¸ ì²˜ë¦¬ (ì›ë³¸ ìœ ì§€, critical_exception í˜¸ì¶œ ì¶”ê°€)
        except (NoSuchWindowException, WebDriverException) as e:
            logging.error(f"í–‰ {i}: WebDriver ì˜¤ë¥˜ ë°œìƒ (Step 3 - ì‚¬ìš©ì ê²€ìƒ‰)")
            critical_exception(e, "Force1 Search User", i)
        except Exception as e:
            loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸ Force1 Search User ì˜ˆì™¸ ë°œìƒ: {e}")
            ErrorNotice(e, i)
            # SheetUpdatePost(i) # ë£¨í”„ ì¢…ë£Œ ì‹œ ì—…ë°ì´íŠ¸ë˜ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬
            continue # ë‹¤ìŒ í–‰ ì²˜ë¦¬

        # --- ë£¨í”„ ì¢…ë£Œ ì „ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ---
        SheetUpdatePost(i) # ê° í–‰ ì²˜ë¦¬ ì™„ë£Œ í›„ ì €ì¥ëœ ë‚´ìš© ì—…ë°ì´íŠ¸
        logging.info(f"===== í–‰ {i} ì²˜ë¦¬ ì™„ë£Œ =====")
        # --- ë£¨í”„ ê°„ ëŒ€ê¸° ì‹œê°„ (í•„ìš” ì‹œ) ---
        # time.sleep(1) # ì„œë²„ ë¶€í•˜ ê°ì†Œ ëª©ì  ë“±

    logging.info("main_task ì¢…ë£Œ: ëª¨ë“  í–‰ ì²˜ë¦¬ ì™„ë£Œ")


# --- ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜ (ìˆ˜ì •ë¨) ---
def main():
    global driver # ì „ì—­ driver ê°ì²´ ì‚¬ìš© ëª…ì‹œ
    try:
        logging.info("í”„ë¡œì„¸ìŠ¤ ì‹œì‘")
        # Reset í•¨ìˆ˜ í˜¸ì¶œ (ì‹œì‘/ì¢…ë£Œ ì…€ ì½ê¸° ë° ìƒíƒœ í™•ì¸)
        Reset()

        # ì›¹ë“œë¼ì´ë²„ ì´ˆê¸°í™” (get_soomgo_driver ì‚¬ìš©)
        logging.info("ì›¹ë“œë¼ì´ë²„ ì´ˆê¸°í™” ì‹œì‘ (soomgo_login_util ì‚¬ìš©)")
        driver = get_soomgo_driver() # ë¡œê·¸ì¸ ë° ë“œë¼ì´ë²„ ê°ì²´ ì–»ê¸°

        # ë“œë¼ì´ë²„ ì´ˆê¸°í™” ì„±ê³µ ì—¬ë¶€ í™•ì¸
        if not driver:
            logging.error("WebDriver ì´ˆê¸°í™” ì‹¤íŒ¨, ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            # ì‹œíŠ¸ì— ì˜¤ë¥˜ ìƒíƒœ ê¸°ë¡ ì‹œë„
            try:
                SavedUpdateSheetValues(absCell_Status, "âš ï¸ RPA Error")
                SavedUpdateSheetValues(absCell_ETA, "Driver Init Failed")
                SheetUpdatePost(0) # ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            except Exception as sheet_err:
                 logging.error(f"ë“œë¼ì´ë²„ ì´ˆê¸°í™” ì‹¤íŒ¨ ìƒíƒœ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: {sheet_err}")
            sys.exit(1)

        logging.info("ì›¹ë“œë¼ì´ë²„ ì´ˆê¸°í™” ì™„ë£Œ")

        # í•µì‹¬ ì‘ì—… í•¨ìˆ˜ í˜¸ì¶œ
        main_task()

        logging.info("ëª¨ë“  ì‘ì—… ì²˜ë¦¬ ì™„ë£Œ")
        # ìµœì¢… ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
        SavedUpdateSheetValues(absCell_Status, "âœ… RPA Complete")
        SavedUpdateSheetValues(absCell_ETA, "-")
        SavedUpdateSheetValues(absCell_Progress_Percent, "100.0%") # ìµœì¢… ì§„í–‰ë¥ 
        SheetUpdatePost(global_endCell) # ë§ˆì§€ë§‰ ì¸ë±ìŠ¤ë¡œ ì—…ë°ì´íŠ¸ í˜¸ì¶œ

    # ì˜ˆìƒì¹˜ ëª»í•œ Alert ì²˜ë¦¬ (main ë ˆë²¨ì—ì„œë„ ì²˜ë¦¬)
    except UnexpectedAlertPresentException as alert_e:
        logging.warning(f"ë©”ì¸ í”„ë¡œì„¸ìŠ¤ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ Alert ë°œìƒ: {alert_e}")
        try:
            alert = driver.switch_to.alert
            alert_text = alert.text
            logging.warning(f"Alert ë‚´ìš©: {alert_text}. Alertë¥¼ ë‹«ìŠµë‹ˆë‹¤.")
            alert.accept() # ë˜ëŠ” alert.dismiss()
            # Alert ë°œìƒ í›„ ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€? (ì˜ˆ: ì¬ì‹œë„, ì¢…ë£Œ ë“±)
            # ì—¬ê¸°ì„œëŠ” ì˜¤ë¥˜ë¡œ ê°„ì£¼í•˜ê³  ì¢…ë£Œ
            raise Exception(f"Uncaught Alert: {alert_text}") # ì˜¤ë¥˜ë¡œ ë‹¤ì‹œ ë˜ì§
        except NoAlertPresentException:
            logging.error("UnexpectedAlertPresentException ë°œìƒí–ˆìœ¼ë‚˜ Alertë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ.", exc_info=True)
        except Exception as e_alert:
            logging.error(f"Alert ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e_alert}", exc_info=True)
            raise e_alert # ì›ë˜ ì˜¤ë¥˜ë¥¼ ë‹¤ì‹œ ë˜ì§

    # ê¸°íƒ€ ëª¨ë“  ì˜ˆì™¸ ì²˜ë¦¬
    except Exception as e:
        logging.error(f"ë©”ì¸ í•¨ìˆ˜ì—ì„œ ì˜ˆì™¸ ë°œìƒ: {str(e)}", exc_info=True)
        # ì˜¤ë¥˜ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œë„
        try:
            SavedUpdateSheetValues(absCell_Status, "âš ï¸ RPA Error")
            SavedUpdateSheetValues(absCell_ETA, "Runtime Error")
            SheetUpdatePost(0)  # ì˜¤ë¥˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        except Exception as sheet_err:
            logging.error(f"ë©”ì¸ ì˜¤ë¥˜ ìƒíƒœ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì¤‘ ì¶”ê°€ ì˜¤ë¥˜ ë°œìƒ: {sheet_err}")

    # --- ìµœì¢… ì²˜ë¦¬ (finally ë¸”ë¡) ---
    finally:
        # ë“œë¼ì´ë²„ ì¢…ë£Œ
        if driver:
            try:
                logging.info("ë“œë¼ì´ë²„ ì¢…ë£Œ ì¤‘...")
                driver.quit()
                logging.info("ë“œë¼ì´ë²„ ì •ìƒ ì¢…ë£Œ")
            except Exception as quit_err:
                logging.warning(f"ë“œë¼ì´ë²„ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {quit_err}")
        logging.info("RPA ìŠ¤í¬ë¦½íŠ¸ ìµœì¢… ì¢…ë£Œ.")


# --- ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì§„ì…ì  (ì›ë³¸ ìœ ì§€) ---
if __name__ == "__main__":
    try:
        logging.info("í”„ë¡œê·¸ë¨ ì‹œì‘ì  ì§„ì…")
        main()
        logging.info("í”„ë¡œê·¸ë¨ ì •ìƒ ì¢…ë£Œ (main í•¨ìˆ˜ ì™„ë£Œ)")
    except KeyboardInterrupt:
        logging.warning("í”„ë¡œê·¸ë¨ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤ (Ctrl+C).")
        loggin('warning', "í”„ë¡œê·¸ë¨ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
        # ì¤‘ë‹¨ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œë„
        try:
            SavedUpdateSheetValues(absCell_Status, "âš ï¸ RPA Interrupted")
            SavedUpdateSheetValues(absCell_ETA, "-")
            SheetUpdatePost(0)  # ìƒíƒœ ì—…ë°ì´íŠ¸
            if driver: # ë“œë¼ì´ë²„ê°€ ì´ˆê¸°í™”ë˜ì—ˆë‹¤ë©´ ì¢…ë£Œ ì‹œë„
                driver.quit()
        except Exception as final_err:
            logging.error(f"ê°•ì œ ì¢…ë£Œ ì‹œ í›„ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {final_err}")
        sys.exit(0) # ì •ìƒ ì¢…ë£Œ ì½”ë“œ (ì‚¬ìš©ì ì¤‘ë‹¨)
    except Exception as e:
        logging.critical(f"ì˜ˆìƒì¹˜ ëª»í•œ ìµœìƒìœ„ ì˜¤ë¥˜ë¡œ í”„ë¡œê·¸ë¨ ë¹„ì •ìƒ ì¢…ë£Œ: {str(e)}", exc_info=True)
        # ìµœìƒìœ„ ì˜¤ë¥˜ ë°œìƒ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œë„ (ì´ë¯¸ mainì—ì„œ ì²˜ë¦¬í–ˆì„ ìˆ˜ ìˆìŒ)
        try:
            SavedUpdateSheetValues(absCell_Status, "âš ï¸ RPA CRITICAL ERROR")
            SavedUpdateSheetValues(absCell_ETA, "-")
            SheetUpdatePost(0)
            if driver:
                driver.quit()
        except Exception as final_err:
            logging.error(f"ìµœìƒìœ„ ì˜¤ë¥˜ ë°œìƒ ì‹œ í›„ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {final_err}")
        sys.exit(1) # ì˜¤ë¥˜ ì¢…ë£Œ ì½”ë“œ

