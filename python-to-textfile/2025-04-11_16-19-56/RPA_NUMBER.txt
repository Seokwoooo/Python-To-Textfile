import time
import logging
import sys
import os
import traceback # traceback import ì¶”ê°€ (ì˜¤ë¥˜ ë¡œê¹…ì— ì‚¬ìš©)
import gspread
import collections
from google.oauth2.service_account import Credentials # gspread ì¸ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ í†µì¼

# Selenium ê´€ë ¨ import
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import (
    NoSuchElementException,
    NoSuchWindowException,
    TimeoutException,
    WebDriverException,
    UnexpectedAlertPresentException,
    NoAlertPresentException # Alert ì²˜ë¦¬ì— í•„ìš”
)
from selenium.webdriver.common.keys import Keys # Keys import ì¶”ê°€ (ì‚¬ìš©ëœ ê²½ìš° ëŒ€ë¹„)

# --- ìƒˆë¡œ ë§Œë“  ë¡œê·¸ì¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ import ---
# ì´ import êµ¬ë¬¸ì´ ì‘ë™í•˜ë ¤ë©´ soomgo_login_util.py íŒŒì¼ì´ ë™ì¼ í´ë” ë˜ëŠ” PYTHONPATHì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
from soomgo_login_util import get_soomgo_driver

# --- ë¡œê¹… ì„¤ì • (íŒŒì¼ ì´ë¦„ì€ ì›ë³¸ ìœ ì§€) ---
# íŒŒì¼ í•¸ë“¤ëŸ¬ì™€ ìŠ¤íŠ¸ë¦¼ í•¸ë“¤ëŸ¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ì„¤ì •
logging.basicConfig(
    level=logging.INFO,  # INFO ì´ìƒë§Œ ì¶œë ¥ (DEBUG ì œì™¸)
    format='%(asctime)s [%(levelname)s] %(filename)s:%(lineno)d - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S',
    handlers=[
        # ë¡œê·¸ íŒŒì¼ ê²½ë¡œë¥¼ C:/Soomgo/ í´ë”ë¡œ ì§€ì • (í´ë”ê°€ ì¡´ì¬í•´ì•¼ í•¨)
        logging.FileHandler(r"C:\Soomgo\output_all_invalidNumber.txt", encoding="utf-8"), # ì›ë³¸ ë¡œê·¸ íŒŒì¼ëª… ì‚¬ìš©
        logging.StreamHandler(sys.stdout) # ì½˜ì†” ì¶œë ¥ í•¸ë“¤ëŸ¬
    ]
)
logging.info("--------------------------------------------------------------\n\n")
logging.info("ì˜ëª»ëœ ì „í™”ë²ˆí˜¸ RPA í”„ë¡œì„¸ìŠ¤ ì‹œì‘") # ì›ë³¸ ë¡œê·¸ ë©”ì‹œì§€ ì‚¬ìš©

# --- ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ì›ë³¸ ìœ ì§€) ---
driver = None # WebDriver ê°ì²´, main í•¨ìˆ˜ì—ì„œ ì´ˆê¸°í™”ë¨
global_startCell = 0
global_endCell = 0
global_UpdateSheetCellPos = []
global_UpdateSheetCellText = []

#* Reset Var (ì›ë³¸ ìœ ì§€)
# Title Var
g_Classification      = ""
g_Compensation        = ""
g_Reward              = ""
g_Sec_Classification  = ""
g_Detailed_Reason     = ""
startCell_as_string   = ""
endCell_as_string     = ""

# Display Progress
gd_Status             = ""
gd_Progress_Percent   = ""
gd_ETA                = ""

# Display Result
gd_RPA_Result   = ""
gd_RPA_Detail   = ""
gd_RPA_Error    = ""

#* Cell Row (ì›ë³¸ ìœ ì§€)
cellRow_Classification      = "M"
cellRow_Compensation        = "N"
cellRow_Reward              = "O"
cellRow_Sec_Classification  = "P"
cellRow_Detailed_Reason     = "Q"
cellRow_RPA_Result          = "S"
cellRow_RPA_Detail          = "T"
cellRow_RPA_Error           = "U"
cellRow_Url                 = "E"
cellRow_Report_Date         = "B"
cellRow_Reporter_ID         = "C"

#* Absolute Cell (ì›ë³¸ ìœ ì§€)
absCell_Status              = "M2"
absCell_Progress_Percent    = "O2"
absCell_ETA                 = "Q2"
absCell_StartCell           = "C3"
absCell_EndCell             = "C4"

#* Calculation Var (ì›ë³¸ ìœ ì§€)
saved_Running_Time_List = collections.deque(maxlen=5)
start_Time = 0
# end_Time ë³€ìˆ˜ëŠ” ì‚¬ìš©ë˜ì§€ ì•Šì•„ ì£¼ì„ ì²˜ë¦¬ ë˜ëŠ” ì‚­ì œ ê°€ëŠ¥ (ì›ë³¸ì— ìˆì—ˆìœ¼ë©´ ìœ ì§€)
# end_Time = 0

# --- Google Sheets API ì—°ê²° (ì›Œí¬ì‹œíŠ¸ ì´ë¦„ ì›ë³¸ ìœ ì§€) ---
logging.info("Google Sheets API ì—°ê²° ì‹œì‘")
# json_key ë³€ìˆ˜ëª… ë° ê²½ë¡œ ì›ë³¸ ìœ ì§€
json_key = "C:/Soomgo/soomgo-lucian-python-8b307b229260.json" # ì‹¤ì œ ê²½ë¡œ í™•ì¸ í•„ìš”
try:
    # scope ë³€ìˆ˜ëª… ë° ë‚´ìš© ì›ë³¸ ìœ ì§€ (í•„ìš”í•œ ê¶Œí•œ í¬í•¨)
    scope = ["https://spreadsheets.google.com/feeds", 'https://www.googleapis.com/auth/spreadsheets',
             "https://www.googleapis.com/auth/drive.file", "https://www.googleapis.com/auth/drive"]
    # ì¸ì¦ ë°©ì‹ í†µì¼ (google-auth ì‚¬ìš©)
    creds = Credentials.from_service_account_file(json_key, scopes=scope)
    gc = gspread.authorize(creds)

    # sheet_url ë³€ìˆ˜ëª… ë° URL ì›ë³¸ ìœ ì§€
    sheet_url = "https://docs.google.com/spreadsheets/d/113wd2xQ1Vy-XhwdaEbIz4FOca7QFGFzz129rKtycdQE/edit?usp=sharing"
    sheet_key = sheet_url.split('/')[5]
    doc = gc.open_by_key(sheet_key)
    # sheet ë³€ìˆ˜ëª… ë° ì›Œí¬ì‹œíŠ¸ ì´ë¦„ ì›ë³¸ ìœ ì§€ ("PRA) Invalid Number")
    sheet = doc.worksheet("PRA) Invalid Number") # *** RPA_NUMBER ì›ë³¸ ì›Œí¬ì‹œíŠ¸ ì´ë¦„ ì‚¬ìš© ***
    logging.info(f"Google Sheets '{doc.title}' ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ 'PRA) Invalid Number' ì›Œí¬ì‹œíŠ¸ ì—°ê²° ì™„ë£Œ.") # ë¡œê·¸ ë©”ì‹œì§€ ìˆ˜ì •
except Exception as e:
    logging.error(f"Google Sheets ì—°ê²° ì‹¤íŒ¨: {e}", exc_info=True)
    logging.error("Google Sheetsì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    sys.exit(1) # ì‹œíŠ¸ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì¢…ë£Œ

# --- Helper Functions (PROì™€ êµ¬ì¡° ë™ì¼, ContinueNotice ë‚´ìš©ë§Œ NUMBER ì›ë³¸ ìœ ì§€) ---

# Unified logging helper (PROì™€ ë™ì¼)
def loggin(level, message):
    level = level.lower()
    if level == 'info':
        logging.info(message)
    elif level == 'warning':
        logging.warning(message)
    elif level == 'error':
        logging.error(message)
    else:
        logging.debug(message) # ê¸°ë³¸ê°’ì€ debug ë ˆë²¨

# Reset í•¨ìˆ˜ (PROì™€ ë™ì¼)
def Reset():
    logging.info("Reset í•¨ìˆ˜ ì‹œì‘: ì‹œì‘/ì¢…ë£Œ ì…€ í™•ì¸ ë° ì´ˆê¸°í™”")
    global global_startCell, global_endCell, startCell_as_string, endCell_as_string # ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëª…ì‹œ
    try:
        logging.info("ì‹œíŠ¸ ìƒíƒœ í™•ì¸ ì¤‘...")
        status = sheet.get(absCell_Status)
        startCell = sheet.get(absCell_StartCell)
        endCell = sheet.get(absCell_EndCell)

        status_as_string = "".join(["".join(row) for row in status])
        startCell_as_string = "".join(["".join(row) for row in startCell])
        endCell_as_string = "".join(["".join(row) for row in endCell])

        logging.info(f"í˜„ì¬ ìƒíƒœ: {status_as_string}")
        logging.info(f"ì‹œì‘ ì…€: {startCell_as_string}")
        logging.info(f"ì¢…ë£Œ ì…€: {endCell_as_string}")

        # ìƒíƒœ ì²´í¬ ë¡œì§ ì›ë³¸ ìœ ì§€
        if status_as_string == "RPA Running..":
            loggin('warning', "âš ï¸ Error: ì´ë¯¸ í•´ë‹¹ RPAê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.")
            logging.error("RPAê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘, ì¢…ë£Œí•©ë‹ˆë‹¤.")
            sys.exit(0)
        elif startCell_as_string == "" or startCell_as_string == " ":
            loggin('warning', "âš ï¸ Error: Start Cell ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. Google Sheetì—ì„œ ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
            logging.error("ì‹œì‘ ì…€ì´ ë¹„ì—ˆìŒ, ì¢…ë£Œí•©ë‹ˆë‹¤.")
            sys.exit(0)
        elif endCell_as_string == "" or endCell_as_string == " ":
            loggin('warning', "âš ï¸ Error: End Cell ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. Google Sheetì—ì„œ ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
            logging.error("ì¢…ë£Œ ì…€ì´ ë¹„ì—ˆìŒ, ì¢…ë£Œí•©ë‹ˆë‹¤.")
            sys.exit(0)

        # ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        global_startCell = int(startCell_as_string)
        global_endCell = int(endCell_as_string)

        logging.info(f"ì‹œì‘ ì…€ ë²ˆí˜¸: {global_startCell}")
        logging.info(f"ì¢…ë£Œ ì…€ ë²ˆí˜¸: {global_endCell}")

        # ì‹œì‘ ì…€ ë²”ìœ„ ì²´í¬ ì›ë³¸ ìœ ì§€
        if global_startCell < 7:
            loggin('warning', "âš ï¸ Error: StartCell ê°’ì´ ë³´í˜¸ë²”ìœ„ì¸ 7ë³´ë‹¤ ì‘ìŠµë‹ˆë‹¤. Google Sheetì—ì„œ ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
            logging.error("ì‹œì‘ ì…€ì´ ìµœì†Œê°’ 7ë³´ë‹¤ ì‘ìŒ, ì¢…ë£Œí•©ë‹ˆë‹¤.")
            sys.exit(0)

        logging.info("Reset í•¨ìˆ˜ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ")
    except Exception as e:
        logging.error(f"Reset í•¨ìˆ˜ ì˜¤ë¥˜: {e}", exc_info=True)
        loggin('warning', f"âš ï¸ Reset Error: ì´ˆê¸°í™” ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ. ìƒì„¸ì‚¬ìœ : {e}")
        sys.exit(1)

# ListToString í•¨ìˆ˜ (PROì™€ ë™ì¼)
def ListToString(cellPos):
    logging.debug(f"ListToString í•¨ìˆ˜ í˜¸ì¶œ: ì…€ {cellPos}ì˜ ê°’ ì½ê¸°") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
    try:
        data = sheet.get(cellPos)
        str_Data = "".join(["".join(row) for row in data])
        logging.debug(f"ì…€ {cellPos}ì˜ ê°’: '{str_Data}'") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
        return str_Data
    except Exception as e:
        logging.error(f"ListToString í•¨ìˆ˜ ì˜¤ë¥˜ (ì…€ {cellPos}): {e}")
        loggin('warning', f"âš ï¸ ListToString Error: ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ. ìƒì„¸ì‚¬ìœ : {e}")
        return "A_Error" # ì˜¤ë¥˜ ë°œìƒ ì‹œ ë°˜í™˜ ê°’

# Calculate_Left_Time í•¨ìˆ˜ (PROì™€ ë™ì¼)
def Calculate_Left_Time(i):
    logging.debug(f"Calculate_Left_Time í•¨ìˆ˜ í˜¸ì¶œ: í˜„ì¬ ì¸ë±ìŠ¤ {i}") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
    global global_startCell, global_endCell # ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëª…ì‹œ
    try:
        if i == global_endCell:
            logging.info("ë§ˆì§€ë§‰ ì…€ ì²˜ë¦¬ ì™„ë£Œ. ETA ì—…ë°ì´íŠ¸.")
            SavedUpdateSheetValues(absCell_ETA, "âœ… Done!")
            return

        if i < global_startCell + 5:
            logging.info("ì´ˆê¸° ë‹¨ê³„, ì˜ˆìƒ ì‹œê°„ ê³„ì‚° ì¤‘...")
            SavedUpdateSheetValues(absCell_ETA, "âŒ› ê³„ì‚° ì¤‘...")
            return
        else:
            logging.debug(f"ì‹¤í–‰ ì‹œê°„ ëª©ë¡: {list(saved_Running_Time_List)}") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
            if not saved_Running_Time_List:
                 SavedUpdateSheetValues(absCell_ETA, "âŒ› ê³„ì‚° ì¤‘...")
                 return

            weights = list(range(1, len(saved_Running_Time_List) + 1))
            weighted_sum = sum(t * w for t, w in zip(saved_Running_Time_List, weights))
            total_weights = sum(weights)
            if total_weights == 0:
                SavedUpdateSheetValues(absCell_ETA, "âŒ› ê³„ì‚° ì¤‘...")
                return

            mean = weighted_sum / total_weights
            left_Row = global_endCell - i
            expected_Time = mean * left_Row

            logging.debug(f"ê°€ì¤‘ í‰ê·  ì‹¤í–‰ ì‹œê°„: {mean:.2f}ì´ˆ") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
            logging.debug(f"ë‚¨ì€ í–‰ ìˆ˜: {left_Row}") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
            logging.info(f"ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: {expected_Time:.2f}ì´ˆ")

            if expected_Time > 60:
                min_val = expected_Time // 60
                sec_val = expected_Time % 60
            else:
                min_val = 0
                sec_val = expected_Time

            time_text = f"{min_val:.0f}ë¶„ {sec_val:.1f}ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤."
            logging.info(f"ETA ì—…ë°ì´íŠ¸: {time_text}")
            SavedUpdateSheetValues(absCell_ETA, time_text)
    except Exception as e:
        logging.error(f"Calculate_Left_Time í•¨ìˆ˜ ì˜¤ë¥˜: {e}", exc_info=True)
        loggin('warning', f"âš ï¸ Calculate Time Error: ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ. ìƒì„¸ì‚¬ìœ : {e}")
        SavedUpdateSheetValues(absCell_ETA, "âš ï¸ ê³„ì‚° ì˜¤ë¥˜")

# ErrorNotice í•¨ìˆ˜ (PROì™€ ë™ì¼)
def ErrorNotice(e, i):
    logging.error(f"ErrorNotice í•¨ìˆ˜ í˜¸ì¶œ: í–‰ {i}ì—ì„œ ì˜¤ë¥˜ ë°œìƒ")
    logging.error(f"ì˜¤ë¥˜ ì •ë³´: {str(e)}")

    ec = " ".join([line.lstrip() for line in str(e).splitlines()])
    logging.info(f"ì‹œíŠ¸ {i}í–‰ì— ì˜¤ë¥˜ í‘œì‹œ ì¤‘...")
    SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "âš ï¸")
    SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", f"{ec}")
    SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", "ì˜¤ë¥˜ë°œìƒ, í•´ë‹¹ ì‹ ê³ ê±´ì€ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.")
    logging.info(f"í–‰ {i}ì— ì˜¤ë¥˜ í‘œì‹œ ì™„ë£Œ (ì €ì¥ë¨)")

# *** ContinueNotice í•¨ìˆ˜ (RPA_NUMBER ì›ë³¸ ë¡œì§ ì‚¬ìš©) ***
def ContinueNotice(result, i):
    logging.info(f"ContinueNotice í•¨ìˆ˜ í˜¸ì¶œ: í–‰ {i}, ê²°ê³¼ '{result}'")

    if result == "NormalNumber":
        logging.info(f"í–‰ {i}: ì •ìƒ ì „í™”ë²ˆí˜¸ í™•ì¸")
        SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "âœ…")
        SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", "í•´ë‹¹ ê³ ê°ì˜ ì „í™”ë²ˆí˜¸ëŠ” ëª¨ë‘ ì •ìƒì…ë‹ˆë‹¤.")
        SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", "") # ì˜¤ë¥˜ ì—†ìŒ

        # result ê°’ ìë™ ì…ë ¥ (ì›ë³¸ ë¡œì§ ìœ ì§€)
        SavedUpdateSheetValues(f"{cellRow_Classification}{i}", "ê¸°ì¤€ë¯¸ë‹¬")
        SavedUpdateSheetValues(f"{cellRow_Compensation}{i}", "ë¯¸í•´ë‹¹")
        SavedUpdateSheetValues(f"{cellRow_Sec_Classification}{i}", "ì‹ ê³ ì‚¬ìœ ì— ë¯¸í•´ë‹¹")

        loggin('info', f"âœ… {i}ë²ˆì§¸: í•´ë‹¹ ê³ ê°ì˜ ì „í™”ë²ˆí˜¸ëŠ” ëª¨ë‘ ì •ìƒì…ë‹ˆë‹¤.")
        # SheetUpdatePost(i) # ì¦‰ì‹œ ì—…ë°ì´íŠ¸í• ì§€ ì—¬ë¶€ (ì—¬ê¸°ì„œëŠ” ëª¨ìœ¼ëŠ” ë°©ì‹ ìœ ì§€)

    elif result == "CorrectInvalidNumber":
        logging.info(f"í–‰ {i}: ìœ íš¨í•˜ì§€ ì•Šì€ ì „í™”ë²ˆí˜¸ í™•ì¸")
        SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "âœ”ï¸")
        SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", "ìœ íš¨í•˜ì§€ ì•ŠëŠ” ì „í™”ë²ˆí˜¸ ëŒ€ìƒ ê³ ê°ì…ë‹ˆë‹¤.")
        SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", "") # ì˜¤ë¥˜ ì—†ìŒ
        loggin('info', f"âœ”ï¸ Google Sheet {i}ë²ˆì§¸: ìœ íš¨í•˜ì§€ ì•ŠëŠ” ì „í™”ë²ˆí˜¸ ëŒ€ìƒ ê³ ê°ì…ë‹ˆë‹¤.")
        # SheetUpdatePost(i)

    elif result =="NoPhoneNumber":
        logging.info(f"í–‰ {i}: íœ´ëŒ€í°ë²ˆí˜¸ ì—†ìŒ")
        SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "ğŸ“µ")
        SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", "í”¼ì‹ ê³ ì¸ íœ´ëŒ€í°ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", "") # ì˜¤ë¥˜ ì—†ìŒ
        loggin('info', f"ğŸ“µ Google Sheet {i}ë²ˆì§¸: í”¼ì‹ ê³ ì¸ íœ´ëŒ€í°ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        # SheetUpdatePost(i)

    elif result =="Unsubscribe":
        logging.info(f"í–‰ {i}: íƒˆí‡´ íšŒì›")
        SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "ğŸš«")
        SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", "í”¼ì‹ ê³ ì¸ì€ íƒˆí‡´ íšŒì›ì…ë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ í™•ì¸ ë° ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.")
        SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", "") # ì˜¤ë¥˜ ì—†ìŒ
        loggin('info', f"ğŸš« Google Sheet {i}ë²ˆì§¸: í”¼ì‹ ê³ ì¸ì€ íƒˆí‡´ íšŒì›ì…ë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ í™•ì¸ ë° ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.")
        # SheetUpdatePost(i)

    elif result =="NotNormalPhoneNumber":
        logging.info(f"í–‰ {i}: ë¹„ì •ìƒ ì „í™”ë²ˆí˜¸ í˜•ì‹")
        SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "âŒ")
        SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", "í”¼ì‹ ê³ ì¸ì˜ ì „í™”ë²ˆí˜¸ëŠ” ì¼ë°˜ì ì´ì§€ ì•Šì•„, ìˆ˜ë™ìœ¼ë¡œ í™•ì¸ ë° ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.")
        SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", "") # ì˜¤ë¥˜ ì—†ìŒ
        loggin('info', f"âŒ Google Sheet {i}ë²ˆì§¸: í”¼ì‹ ê³ ì¸ì˜ ì „í™”ë²ˆí˜¸ëŠ” ì¼ë°˜ì ì´ì§€ ì•Šì•„, ìˆ˜ë™ìœ¼ë¡œ í™•ì¸ ë° ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.")
        # SheetUpdatePost(i)

    # ê·¸ ì™¸ì˜ result ê°’ ì²˜ë¦¬ (í•„ìš” ì‹œ ì¶”ê°€)
    # else:
    #     logging.warning(f"í–‰ {i}: ì•Œ ìˆ˜ ì—†ëŠ” ê²°ê³¼ê°’ '{result}'")
    #     SavedUpdateSheetValues(f"{cellRow_RPA_Result}{i}", "â“")
    #     SavedUpdateSheetValues(f"{cellRow_RPA_Detail}{i}", f"ì•Œ ìˆ˜ ì—†ëŠ” ê²°ê³¼: {result}")
    #     SavedUpdateSheetValues(f"{cellRow_RPA_Error}{i}", "")

    logging.info(f"í–‰ {i}ì— ê²°ê³¼ í‘œì‹œ ì™„ë£Œ (ì €ì¥ë¨): {result}")


# SavedUpdateSheetValues í•¨ìˆ˜ (PROì™€ ë™ì¼)
def SavedUpdateSheetValues(cellPos, text):
    logging.debug(f"SavedUpdateSheetValues í•¨ìˆ˜ í˜¸ì¶œ: ì…€ {cellPos}, ê°’ '{text}'") # ë¡œê·¸ ë ˆë²¨ ë³€ê²½ ê°€ëŠ¥
    global global_UpdateSheetCellPos, global_UpdateSheetCellText # ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëª…ì‹œ
    global_UpdateSheetCellPos.append(cellPos)
    global_UpdateSheetCellText.append(text)

# SheetUpdatePost í•¨ìˆ˜ (PROì™€ ë™ì¼)
def SheetUpdatePost(current_index):
    logging.info(f"SheetUpdatePost í•¨ìˆ˜ í˜¸ì¶œ: í˜„ì¬ ì¸ë±ìŠ¤ {current_index}")
    global global_UpdateSheetCellPos, global_UpdateSheetCellText, start_Time, saved_Running_Time_List # ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëª…ì‹œ

    end_time = time.time()
    if start_Time > 0:
        execution_time = end_time - start_Time
        saved_Running_Time_List.append(execution_time)
        logging.info(f"ì´ë²ˆ í–‰ ì‹¤í–‰ ì‹œê°„: {execution_time:.2f}ì´ˆ")
    else:
        logging.warning("start_Timeì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì‹¤í–‰ ì‹œê°„ì„ ê¸°ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    if global_startCell == current_index:
        logging.info("ì²« ë²ˆì§¸ í–‰ ì²˜ë¦¬, RPA ì‹¤í–‰ ì¤‘ ìƒíƒœë¡œ ë³€ê²½")
        SavedUpdateSheetValues(absCell_Status, "RPA Running..")

    try:
        if global_UpdateSheetCellPos and global_UpdateSheetCellText:
            logging.info(f"êµ¬ê¸€ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ í•­ëª© ìˆ˜: {len(global_UpdateSheetCellPos)}")

            updates = []
            for pos, text in zip(global_UpdateSheetCellPos, global_UpdateSheetCellText):
                updates.append({
                    "range": pos,
                    "values": [[str(text)]]
                })

            logging.info("sheet.batch_update í˜¸ì¶œ ì¤‘...")
            sheet.batch_update(updates)
            loggin('info', f"âœ… Google Sheet Update ì„±ê³µ. ì—…ë°ì´íŠ¸ ê°œìˆ˜: {len(global_UpdateSheetCellPos)}")

            for pos, text in zip(global_UpdateSheetCellPos, global_UpdateSheetCellText):
                logging.debug(f"ğŸ”ƒ ì—…ë°ì´íŠ¸í•œ ì…€: {pos}, ê°’: {text}")

            logging.info("êµ¬ê¸€ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ")
        else:
            logging.info("êµ¬ê¸€ ì‹œíŠ¸ì— ì—…ë°ì´íŠ¸í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.")

    except Exception as e:
        logging.error(f"SheetUpdatePost ì˜¤ë¥˜: {e}", exc_info=True)
        loggin('warning', f"!!! Sheet Update Post ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

    logging.debug("ì—…ë°ì´íŠ¸ ëª©ë¡ ì´ˆê¸°í™”")
    global_UpdateSheetCellText = []
    global_UpdateSheetCellPos = []

# --- ì¹˜ëª…ì  ì˜ˆì™¸ ì²˜ë¦¬ í•¨ìˆ˜ (PROì™€ ë™ì¼ êµ¬ì¡°, ì„¸ì…˜ ë³µêµ¬ ë¡œì§ ì œê±°ë¨) ---
def critical_exception(e, context, i):
    global driver
    loggin('warning', f"âš ï¸ critical_exception ë°œìƒ: {context}")
    logging.error(f"ì˜ˆì™¸ ì •ë³´: {str(e)}")
    logging.error(f"ì˜ˆì™¸ íƒ€ì…: {type(e).__name__}")
    logging.error(f"ìƒì„¸ Traceback:\n{traceback.format_exc()}")

    logging.error(f"ì¹˜ëª…ì  ì˜¤ë¥˜ë¡œ RPA ì¢…ë£Œ: {context}")
    try:
        SavedUpdateSheetValues(absCell_Status, "âš ï¸ RPA Error")
        SavedUpdateSheetValues(absCell_ETA, "-")
        ErrorNotice(e, i)
        SheetUpdatePost(i)
    except Exception as sheet_update_err:
        logging.error(f"ì˜¤ë¥˜ ìƒíƒœ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì¤‘ ì¶”ê°€ ì˜¤ë¥˜ ë°œìƒ: {sheet_update_err}")

    loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸ {context}ì—ì„œ ì˜ˆì™¸ ë°œìƒí•˜ì—¬ RPA ì¢…ë£Œ: {e}")

    if driver:
        try:
            logging.info("ë“œë¼ì´ë²„ ì¢…ë£Œ ì‹œë„...")
            driver.quit()
            logging.info("ë“œë¼ì´ë²„ ì¢…ë£Œ ì™„ë£Œ.")
        except Exception as quit_err:
            logging.warning(f"ë“œë¼ì´ë²„ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {quit_err}")
    logging.info("í”„ë¡œê·¸ë¨ ì¢…ë£Œ.")
    sys.exit(1)

# --- í•µì‹¬ RPA ì‘ì—… ë¡œì§ í•¨ìˆ˜ (main_task - RPA_NUMBER ì›ë³¸ ë¡œì§ ì‚¬ìš© + TimeoutException ì²˜ë¦¬) ---
def main_task():
    logging.info("main_task ì‹œì‘: ì˜ëª»ëœ ë²ˆí˜¸ ì²˜ë¦¬ ë£¨í”„ ì§„ì…")
    global start_Time, driver # ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ëª…ì‹œ

    # ë©”ì¸ ë¡œì§: forë¬¸ì„ í†µí•´ ê° ì‹ ê³  ê±´ì„ ì²˜ë¦¬ (RPA_NUMBER ì›ë³¸ ë¡œì§)
    for i in range(global_startCell, global_endCell + 1):
        start_Time = time.time() # ê° í–‰ ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
        logging.info(f"===== í–‰ {i} ì²˜ë¦¬ ì‹œì‘ =====")
        try:
            # ì§„í–‰ë¥  ë° ETA ê³„ì‚°
            Calculate_Left_Time(i)
            progress_percent = ((i - global_startCell + 1) / (global_endCell - global_startCell + 1)) * 100
            SavedUpdateSheetValues(absCell_Progress_Percent, f"{progress_percent:.1f}%")

            result = "" # ê²°ê³¼ ë³€ìˆ˜ ì´ˆê¸°í™”

            # ìœ íš¨ì„± ê²€ì‚¬ (ì›ë³¸ ë¡œì§)
            logging.info(f"í–‰ {i}: ìœ íš¨ì„± ê²€ì‚¬")
            report_Date = ListToString(f"{cellRow_Report_Date}{i}").strip()
            reporter_ID = ListToString(f"{cellRow_Reporter_ID}{i}").strip()

            if report_Date == "" or reporter_ID == "":
                logging.warning(f"í–‰ {i}: í•„ìˆ˜ ì •ë³´(ì‹ ê³ ìID ë˜ëŠ” ì‹ ê³ ì¼) ëˆ„ë½")
                loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸Sheetì— í•„ìˆ˜ ì •ë³´ì¸ ì‹ ê³ ìID ë˜ëŠ” ì‹ ê³ ì¼ ê°’ì´ ì—†ìŠµë‹ˆë‹¤.")
                ErrorNotice("í•„ìˆ˜ ì •ë³´ ëˆ„ë½ (ì‹ ê³ ìID ë˜ëŠ” ì‹ ê³ ì¼)", i)
                SheetUpdatePost(i)
                continue

            # Step 1: Force URL ì ‘ì† í›„ 'íƒˆí‡´'ì¸ì§€ ì²´í¬ (ì›ë³¸ ë¡œì§)
            logging.info(f"í–‰ {i}: Step 1 ì‹œì‘ - Force URL ì ‘ì† í›„ ìƒíƒœ í™•ì¸")
            phoneNumber = "" # ì „í™”ë²ˆí˜¸ ë³€ìˆ˜ ì´ˆê¸°í™”
            url = ListToString(f"{cellRow_Url}{i}")
            if url == "A_Error":
                logging.error(f"í–‰ {i}: URL ì½ê¸° ì‹¤íŒ¨ (A_Error)")
                ErrorNotice("URL ì½ê¸° ì˜¤ë¥˜", i)
                SheetUpdatePost(i)
                continue
            if not url.startswith("http"):
                 logging.error(f"í–‰ {i}: ìœ íš¨í•˜ì§€ ì•Šì€ URL '{url}', ê±´ë„ˆ<0xEB><0><0x8E><0x84>ë‹ˆë‹¤.")
                 ErrorNotice(f"Invalid URL: {url}", i)
                 SheetUpdatePost(i)
                 continue

            logging.info(f"í–‰ {i}: URL ì ‘ì† ì¤‘ - {url}")
            driver.get(url)

            # íšŒì› ìƒíƒœ í™•ì¸ (ì›ë³¸ XPath ìœ ì§€)
            logging.info(f"í–‰ {i}: íšŒì› ìƒíƒœ í™•ì¸ ì¤‘")
            status_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[1]/div[1]/div[2]/table/tbody/tr[5]/td[2]'
            status = WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, status_xpath))
            ).text.strip()
            logging.info(f"í–‰ {i}: íšŒì› ìƒíƒœ - '{status}'")

            if "íƒˆí‡´" in status:
                logging.info(f"í–‰ {i}: íƒˆí‡´ íšŒì› í™•ì¸ë¨")
                result = "Unsubscribe"
                ContinueNotice(result, i)
                SheetUpdatePost(i)
                continue

            # ì „í™”ë²ˆí˜¸ nullì¸ì§€ ê²€ì‚¬ (ì›ë³¸ ë¡œì§)
            logging.info(f"í–‰ {i}: íœ´ëŒ€í° ë²ˆí˜¸ í™•ì¸ ì‹œì‘")
            phone_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[1]/div[1]/div[2]/table/tbody/tr[11]/td[2]'
            elem = WebDriverWait(driver, 20).until(
                EC.presence_of_element_located((By.XPATH, phone_xpath))
            )
            logging.info(f"í–‰ {i}: íœ´ëŒ€í° ë²ˆí˜¸ ìš”ì†Œ ì°¾ìŒ, ê°’: '{elem.text}'")
            phone_text = elem.text.strip() # ê³µë°± ì œê±° í›„ ì‚¬ìš©

            if phone_text != "":
                phoneNumber = phone_text
                logging.info(f"í–‰ {i}: íœ´ëŒ€í° ë²ˆí˜¸ ìˆìŒ - {phoneNumber}")
                # ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì‚¬ (010 ì‹œì‘ ì—¬ë¶€ - ì›ë³¸ ë¡œì§)
                if not phoneNumber.startswith("010"):
                    logging.info(f"í–‰ {i}: ë¹„ì •ìƒ í˜•ì‹ íœ´ëŒ€í° ë²ˆí˜¸ - {phoneNumber}")
                    result = "NotNormalPhoneNumber"
                    ContinueNotice(result, i)
                    SheetUpdatePost(i)
                    continue
                # í˜•ì‹ ê²€ì‚¬ í†µê³¼ ì‹œ ê³„ì† ì§„í–‰
            else: # ì „í™”ë²ˆí˜¸ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš°
                logging.info(f"í–‰ {i}: íœ´ëŒ€í° ë²ˆí˜¸ ì—†ìŒ")
                result = "NoPhoneNumber"
                ContinueNotice(result, i)
                SheetUpdatePost(i)
                continue

            # Step 2: ì‹ ê³  ê±´ì˜ ì„œë¹„ìŠ¤ ì¹´í…Œê³ ë¦¬ í¬ë¡¤ë§ (RPA_NUMBER ì›ë³¸ ë¡œì§ - ê²¬ì  ë²„íŠ¼ í™•ì¸ ë° ì•ˆì‹¬ë²ˆí˜¸ í™•ì¸)
            logging.info(f"í–‰ {i}: Step 2 ì‹œì‘ - ê²¬ì  ë° ì•ˆì‹¬ë²ˆí˜¸ ì •ë³´ í™•ì¸")

            # ì‹ ê³ ì¼/ì‹ ê³ ì ID ë§¤ì¹­ (RPA_PRO ë¡œì§ ì¬ì‚¬ìš© - í•„ìš” ì‹œ ìˆ˜ì •)
            logging.info(f"í–‰ {i}: í”¼ì‹ ê³  ë‚´ì—­ í™•ì¸ ìœ„í•´ '{url}?size=100' ì ‘ì†")
            driver.get(f"{url}?size=100")
            time.sleep(2) # ì›ë³¸ ìœ ì§€

            elements_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr'
            elements = WebDriverWait(driver, 20).until(
                EC.presence_of_all_elements_located((By.XPATH, elements_xpath))
            )
            loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / Force1 í”¼ì‹ ê³ ë‚´ì—­ì—ì„œ [{len(elements)}] ê±´ì˜ ì‹ ê³ ë‚´ì—­ì„ ì°¾ì•„ ì²˜ë¦¬í•©ë‹ˆë‹¤.")

            matching_rows_index = []
            for index in range(1, len(elements) + 1):
                try:
                    date_xpath = f'//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr[{index}]/td[8]'
                    full_date_element = WebDriverWait(driver, 10).until(
                        EC.presence_of_element_located((By.XPATH, date_xpath))
                    )
                    date_only = full_date_element.text.split(" ")[0]
                    loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ Row {index} ë‚ ì§œ: {date_only}")
                    if date_only == report_Date:
                        loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ ë‚ ì§œ ì¼ì¹˜ (Row {index})")
                        matching_rows_index.append(index)
                except (NoSuchWindowException, WebDriverException) as e:
                     logging.error(f"í–‰ {i}, Row {index}: WebDriver ì˜¤ë¥˜ ë°œìƒ (Step 2 - ë‚ ì§œ ì¶”ì¶œ)")
                     critical_exception(e, f"ë‚ ì§œ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ (Row {index})", i)
                except Exception as e:
                    loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸ ë‚ ì§œ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ (Row {index}): {e}")

            loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ ë‚ ì§œ ì¼ì¹˜ í–‰ ì¸ë±ìŠ¤: {matching_rows_index}")
            if not matching_rows_index:
                loggin('error', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / ì‹ ê³ ì¼({report_Date})ê³¼ ì¼ì¹˜í•˜ëŠ” í”¼ì‹ ê³  ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                raise Exception("ì‹ ê³ ì¼ê³¼ ì¼ì¹˜í•˜ëŠ” í”¼ì‹ ê³ ë‚´ì—­ì„ 1ê°œë„ ì°¾ì„ ìˆ˜ ì—†ì–´ ì˜ˆì™¸ë°œìƒ")

            find_Correct_Reportlist_row = -1
            error_occurred_in_id_check = False
            for n in matching_rows_index:
                logging.info(f"í–‰ {i}, Row {n}: ì‹ ê³ ì ID í™•ì¸ ìœ„í•´ ìƒì„¸ í˜ì´ì§€ ì´ë™ ì‹œë„")
                driver.get(f"{url}?size=100")
                time.sleep(1)
                try:
                    if len(elements) == 1 and index == 1: # ì›ë³¸ ì½”ë“œì—ì„œëŠ” index ë³€ìˆ˜ê°€ ë£¨í”„ ë°–ì—ì„œ ì‚¬ìš©ë  ìˆ˜ ì—†ìŒ -> n ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
                         button_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr/td[3]/a/button'
                    else:
                         button_xpath = f'//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr[{n}]/td[3]/a/button'

                    button = WebDriverWait(driver, 20).until(
                        EC.element_to_be_clickable((By.XPATH, button_xpath))
                    )
                    button.click()
                    logging.info(f"í–‰ {i}, Row {n}: ìƒì„¸ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì„±ê³µ")
                    time.sleep(1)

                    id_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[1]/div[1]/div[2]/table/tbody/tr[1]/td[2]'
                    id_text = WebDriverWait(driver, 10).until(
                        lambda d: d.find_element(By.XPATH, id_xpath).text.strip() or False
                    )
                    loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ Force2 ê³ ìˆ˜í˜ì´ì§€ íšŒì›ë²ˆí˜¸: {id_text} (Row {n})")
                    if reporter_ID == id_text:
                        find_Correct_Reportlist_row = n
                        logging.info(f"í–‰ {i}: ì‹ ê³ ì ID ì¼ì¹˜! (Row {n})")
                        break
                except (NoSuchWindowException, WebDriverException) as e:
                     logging.error(f"í–‰ {i}, Row {n}: WebDriver ì˜¤ë¥˜ ë°œìƒ (Step 2 - ID í™•ì¸)")
                     critical_exception(e, f"ì‹ ê³ ì ID í™•ì¸ ì¤‘ ì˜¤ë¥˜ (Row {n})", i)
                except Exception as e:
                    loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸ ë²„íŠ¼ í´ë¦­ ë˜ëŠ” ID ì¶”ì¶œ ì‹¤íŒ¨ (Row {n}): {e}")
                    error_occurred_in_id_check = True
                    # break # ì˜¤ë¥˜ ì‹œ ì¤‘ë‹¨í• ì§€ ì—¬ë¶€

            if error_occurred_in_id_check and find_Correct_Reportlist_row == -1:
                 loggin('error', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / ëª¨ë“  í–‰ì—ì„œ ì‹ ê³ ì ID í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ë˜ëŠ” ë¶ˆì¼ì¹˜.")
                 ErrorNotice("ì‹ ê³ ì ID í™•ì¸ ì‹¤íŒ¨", i)
                 SheetUpdatePost(i)
                 continue

            if find_Correct_Reportlist_row == -1:
                 loggin('error', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / ì‹ ê³ ì¼ì€ ì¼ì¹˜í•˜ë‚˜ ì‹ ê³ ì ID({reporter_ID})ê°€ ì¼ì¹˜í•˜ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.")
                 ErrorNotice("ì‹ ê³ ì ID ë¶ˆì¼ì¹˜", i)
                 SheetUpdatePost(i)
                 continue

            # ì•ˆì‹¬ë²ˆí˜¸ í™•ì¸ ë¡œì§ ì‹œì‘ (RPA_NUMBER ì›ë³¸)
            logging.info(f"í–‰ {i}: ì•ˆì‹¬ë²ˆí˜¸ í™•ì¸ ë¡œì§ ì‹œì‘ (Row {find_Correct_Reportlist_row})")
            driver.get(url) # ì›ë˜ í˜ì´ì§€ë¡œ ëŒì•„ê°
            time.sleep(1)
            row_for_service = find_Correct_Reportlist_row # ë³€ìˆ˜ëª…ì€ ê°™ì§€ë§Œ ì—¬ê¸°ì„œëŠ” ì•ˆì‹¬ë²ˆí˜¸ í™•ì¸ì— ì‚¬ìš©

            # ìš”ì²­ì„œ ë²„íŠ¼ ë° ê²¬ì  ë²„íŠ¼ í™•ì¸ (ì›ë³¸ XPath ìœ ì§€)
            # len(elements) == 1 ì¡°ê±´ ìˆ˜ì •: find_Correct_Reportlist_row ì‚¬ìš©
            if len(elements) == 1 and row_for_service == 1:
                request_Button_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr/td[1]/a/button'
                estimate_Button_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr/td[2]/a/button'
            else:
                request_Button_xpath = f'//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr[{row_for_service}]/td[1]/a/button'
                estimate_Button_xpath = f'//*[@id="root"]/div/main/div[2]/div[2]/div[2]/div[3]/div/div[3]/div/table/tbody/tr[{row_for_service}]/td[2]/a/button'

            logging.info(f"í–‰ {i}: ìš”ì²­ì„œ ë²„íŠ¼ í™•ì¸ ì¤‘")
            request_Button = WebDriverWait(driver, 20).until(
                EC.presence_of_element_located((By.XPATH, request_Button_xpath))
            )
            logging.info(f"í–‰ {i}: ìš”ì²­ì„œ ë²„íŠ¼ í™•ì¸ë¨")

            has_estimate_button = False
            if request_Button: # ìš”ì²­ì„œ ë²„íŠ¼ì´ ìˆìœ¼ë©´ ê²¬ì  ë²„íŠ¼ í™•ì¸
                logging.info(f"í–‰ {i}: ê²¬ì  ë²„íŠ¼ í™•ì¸ ì¤‘")
                try:
                    estimate_Button = WebDriverWait(driver, 5).until(
                        EC.presence_of_element_located((By.XPATH, estimate_Button_xpath))
                    )
                    logging.info(f"í–‰ {i}: ê²¬ì  ë²„íŠ¼ í™•ì¸ë¨")
                    has_estimate_button = True
                except Exception as e:
                    logging.warning(f"í–‰ {i}: ê²¬ì  ë²„íŠ¼ ì—†ìŒ(URL_2ê°€ ë¹„ì–´ìˆìŒ) - {str(e)}")
                    has_estimate_button = False
                    # ê²¬ì  ë²„íŠ¼ ì—†ìœ¼ë©´ ì •ìƒ ë²ˆí˜¸ ì²˜ë¦¬ (ì›ë³¸ ë¡œì§)
                    logging.info(f"í–‰ {i}: ê²¬ì  ë²„íŠ¼ ì—†ìŒ, ì •ìƒ ì „í™”ë²ˆí˜¸ë¡œ ì²˜ë¦¬")
                    result = "NormalNumber"
                    ContinueNotice(result, i)
                    SheetUpdatePost(i)
                    continue # ë‹¤ìŒ í–‰ìœ¼ë¡œ

            # ê²¬ì  ë²„íŠ¼ì´ ìˆëŠ” ê²½ìš° ì•ˆì‹¬ë²ˆí˜¸ í™•ì¸ ì§„í–‰ (ì›ë³¸ ë¡œì§)
            if has_estimate_button:
                try:
                    logging.info(f"í–‰ {i}: ê²¬ì  ë²„íŠ¼ í´ë¦­ ì¤€ë¹„")
                    old_Url = driver.current_url
                    logging.info(f"í–‰ {i}: í˜„ì¬ URL: {old_Url}")
                    # estimate_Button ë³€ìˆ˜ê°€ try ë¸”ë¡ ë‚´ì— ìˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ ì°¾ì•„ì•¼ í•  ìˆ˜ ìˆìŒ
                    estimate_Button = WebDriverWait(driver, 5).until(
                        EC.element_to_be_clickable((By.XPATH, estimate_Button_xpath))
                    )
                    estimate_Button.click()
                    logging.info(f"í–‰ {i}: ê²¬ì  ë²„íŠ¼ í´ë¦­ë¨, URL ë³€ê²½ ëŒ€ê¸° ì¤‘")

                    WebDriverWait(driver, 20).until(EC.url_changes(old_Url))
                    new_url = driver.current_url
                    logging.info(f"í–‰ {i}: URL ë³€ê²½ë¨, ìƒˆ URL: {new_url}")

                    # ì•ˆì‹¬ë²ˆí˜¸ ì •ë³´ ë²„íŠ¼ í´ë¦­ (ì›ë³¸ XPath ìœ ì§€)
                    safeNumberInfoButton_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[1]/div/div/a[2]'
                    safeNumberInfoButton = WebDriverWait(driver, 10).until(
                        EC.presence_of_element_located((By.XPATH, safeNumberInfoButton_xpath))
                    )
                    logging.info(f"í–‰ {i}: ì•ˆì‹¬ë²ˆí˜¸ ì •ë³´ ë²„íŠ¼ í´ë¦­")
                    safeNumberInfoButton.click()

                    # ì•ˆì‹¬ë²ˆí˜¸ ì •ë³´ í…Œì´ë¸” ë¡œë”© ëŒ€ê¸° (ì›ë³¸ XPath ìœ ì§€)
                    safeNumberTable_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/table/tbody/tr'
                    WebDriverWait(driver, 20).until(
                        EC.presence_of_element_located((By.XPATH, safeNumberTable_xpath))
                    )
                    logging.info(f"í–‰ {i}: ì•ˆì‹¬ë²ˆí˜¸ ì •ë³´ í…Œì´ë¸” ë¡œë”©ë¨")

                # ì•ˆì‹¬ë²ˆí˜¸ í™•ì¸ WebDriver ì˜ˆì™¸ ì²˜ë¦¬ (critical_exception í˜¸ì¶œ)
                except (NoSuchWindowException, WebDriverException) as e:
                     logging.error(f"í–‰ {i}: WebDriver ì˜¤ë¥˜ ë°œìƒ (Step 2 - ì•ˆì‹¬ë²ˆí˜¸ ë²„íŠ¼ í´ë¦­)")
                     critical_exception(e, "ì•ˆì‹¬ë²ˆí˜¸ ë²„íŠ¼ í´ë¦­", i)
                # ì•ˆì‹¬ë²ˆí˜¸ í™•ì¸ ê¸°íƒ€ ì˜ˆì™¸ ì²˜ë¦¬
                except Exception as e:
                    logging.error(f"í–‰ {i}: ê²¬ì  ë²„íŠ¼ ë˜ëŠ” ì•ˆì‹¬ë²ˆí˜¸ ì •ë³´ ë²„íŠ¼ í´ë¦­ ì‹¤íŒ¨ - {str(e)}")
                    loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸estimate_Button ë˜ëŠ” safeNumberInfoButton ë²„íŠ¼ í´ë¦­ ì‹¤íŒ¨: {e}")
                    ErrorNotice(e, i)
                    SheetUpdatePost(i)
                    continue

                # ì•ˆì‹¬ë²ˆí˜¸ ìƒíƒœ ê°’ í™•ì¸ (TimeoutException ì²˜ë¦¬ ìˆ˜ì •ë¨)
                try:
                    logging.info(f"í–‰ {i}: ì•ˆì‹¬ë²ˆí˜¸ ì •ë³´ í™•ì¸ ì‹œì‘")
                    # ì²« ë²ˆì§¸ ì…€ í™•ì¸ (ë°ì´í„° ì—†ìŒ í™•ì¸ìš© - ì›ë³¸ ë¡œì§)
                    row_elem_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/table/tbody/tr/td'
                    row_elem = WebDriverWait(driver, 20).until(
                        EC.presence_of_element_located((By.XPATH, row_elem_xpath))
                    )
                    logging.info(f"í–‰ {i}: ì²« ë²ˆì§¸ ì…€ ë¡œë“œë¨")
                    time.sleep(1)  # ì›ë³¸ ìœ ì§€

                    # ìƒíƒœ ì •ë³´ ì…€(8ë²ˆì§¸ ì—´) í™•ì¸ (ì›ë³¸ ë¡œì§)
                    status_span_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/table/tbody/tr/td[8]/span'
                    try:
                        # *** TimeoutException ì²˜ë¦¬ ìˆ˜ì • ì ìš© ***
                        # ëŒ€ê¸° ì‹œê°„ì„ 10ì´ˆë¡œ ëŠ˜ë¦¼
                        status_elem = WebDriverWait(driver, 10).until(
                            EC.presence_of_element_located((By.XPATH, status_span_xpath))
                        )
                        logging.info(f"í–‰ {i}: ìƒíƒœ ì •ë³´ ì…€(span) ìˆìŒ")
                        numberStatusValue = status_elem.text.strip()
                        logging.info(f"í–‰ {i}: ì•ˆì‹¬ë²ˆí˜¸ ìƒíƒœ ê°’: '{numberStatusValue}'")

                        # ìƒíƒœ ê°’ ë¹„êµ (ì›ë³¸ ë¡œì§)
                        loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ numberStatusValue -> {numberStatusValue}")
                        if "ì°©ì‹ ë²ˆí˜¸ ê²°ë²ˆ í˜¹ì€ ìœ íš¨í•˜ì§€ ì•Šì€ ë²ˆí˜¸" == numberStatusValue:
                            result = "CorrectInvalidNumber"
                        elif "ì°©ì‹ ì‹œë„ì¤‘ ë°œì‹ ì¸¡ í˜¸ ì¢…ë£Œ" == numberStatusValue:
                            result = "NormalNumber"
                        elif "í†µí™”ì„±ê³µ" == numberStatusValue:
                            result = "NormalNumber"
                        elif "ì°©ì‹  ë¬´ì‘ë‹µ" == numberStatusValue:
                            result = "NormalNumber"
                        elif "ì°©ì‹  í†µí™”ì¤‘" == numberStatusValue:
                            result = "NormalNumber"
                        elif "" == numberStatusValue: # ìƒíƒœê°’ì´ ë¹„ì–´ìˆëŠ” ê²½ìš°
                            logging.info(f"í–‰ {i}: ìƒíƒœê°’ì´ ë¹„ì–´ìˆìŒ, í†µí™”ì‹œê°„ Tableì— 0ì´ˆë¼ê³  ì í˜€ìˆëŠ”ì§€ ì²´í¬ ì‹œì‘")
                            status_span_callingtime_xpath = '//*[@id="root"]/div/main/div[2]/div[2]/div[2]/table/tbody/tr[1]/td[7]/span'
                            
                            try:
                                callingtime_table_elem = WebDriverWait(driver, 3).until(
                                    EC.presence_of_element_located((By.XPATH, status_span_callingtime_xpath))
                                )
                                logging.info(f"í–‰ {i}: ìƒíƒœ ì •ë³´ ì…€(span) ìˆìŒ")
                                callingTimeValue = callingtime_table_elem.text.strip()
                                if "0" in callingTimeValue or "ì´ˆ" in callingTimeValue:
                                    logging.info(f"í–‰ {i}: Calling Timeì´ 0ì´ˆ ë˜ëŠ” {callingTimeValue}, ì •ìƒì²˜ë¦¬")
                                    result = "NormalNumber"
                                else:
                                    raise Exception("ì•ˆì‹¬ë²ˆí˜¸ ìƒíƒœê°’ ë¹„ì–´ìˆìŒ") # ì˜¤ë¥˜ë¡œ ê°„ì£¼
                            except:
                                logging.error(f"í–‰ {i}: Calling Time í™•ì¸ ì‹¤íŒ¨ - {str(e)}", exc_info=True)
                                loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / Calling Time í™•ì¸ ì‹¤íŒ¨: {e}")
                                ErrorNotice(e, i)
                                continue # ë‹¤ìŒ í–‰ìœ¼ë¡œ

                        else: # ì˜ˆìƒ ëª»í•œ ìƒíƒœê°’
                             logging.warning(f"í–‰ {i}: ì˜ˆìƒ ëª»í•œ ì•ˆì‹¬ë²ˆí˜¸ ìƒíƒœê°’ '{numberStatusValue}'")
                             raise Exception(f"í–‰ {i}: ì˜ˆìƒ ëª»í•œ ì•ˆì‹¬ë²ˆí˜¸ ìƒíƒœê°’ ") # ì˜¤ë¥˜ë¡œ ê°„ì£¼

                        ContinueNotice(result, i)

                    # *** TimeoutException ì²˜ë¦¬ ìˆ˜ì • ì ìš© ***
                    except (NoSuchElementException, TimeoutException):
                        # ìƒíƒœ span ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í•˜ê±°ë‚˜ íƒ€ì„ì•„ì›ƒ ë°œìƒ ì‹œ
                        logging.info(f"í–‰ {i}: ìƒíƒœ ì •ë³´ ìš”ì†Œ(span) ì—†ìŒ ë˜ëŠ” íƒ€ì„ì•„ì›ƒ ë°œìƒ")
                        # Fallback: ì²« ë²ˆì§¸ ì…€ í…ìŠ¤íŠ¸ í™•ì¸ ("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                        time.sleep(1) # ì›ë³¸ ìœ ì§€
                        try:
                            td_text = driver.execute_script("return arguments[0].innerText;", row_elem).strip()
                        except Exception as js_err:
                            logging.warning(f"í–‰ {i}: ì²« ë²ˆì§¸ ì…€ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨ (JavaScript ì˜¤ë¥˜): {js_err}")
                            td_text = ""

                        logging.info(f"í–‰ {i}: ì²« ë²ˆì§¸ ì…€ í…ìŠ¤íŠ¸ ë‚´ìš©: '{td_text}'")
                        loggin('info', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / @ td_text -> {td_text}")

                        if td_text == "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.":
                            logging.info(f"í–‰ {i}: ë°ì´í„° ì—†ìŒ, ì •ìƒ ì „í™”ë²ˆí˜¸ë¡œ ì²˜ë¦¬")
                            result = "NormalNumber"
                            ContinueNotice(result, i)
                        else:
                             # ìƒíƒœ span ì—†ê³ , 'ë°ì´í„° ì—†ìŒ'ë„ ì•„ë‹Œ ê²½ìš° -> ì •ìƒ ê°„ì£¼ (ì›ë³¸ ë¡œì§)
                             logging.warning(f"í–‰ {i}: ìƒíƒœ ì •ë³´ ë¶ˆëª…í™• (span ì—†ìŒ/íƒ€ì„ì•„ì›ƒ, ë°ì´í„° ì—†ìŒ ì•„ë‹˜), ì •ìƒìœ¼ë¡œ ê°„ì£¼")
                             result = "NormalNumber"
                             ContinueNotice(result, i)

                # ì•ˆì‹¬ë²ˆí˜¸ ìƒíƒœ í™•ì¸ ì¤‘ WebDriver ê´€ë ¨ ì˜¤ë¥˜ ì²˜ë¦¬ (critical_exception í˜¸ì¶œ)
                except (NoSuchWindowException, WebDriverException) as e:
                     logging.error(f"í–‰ {i}: WebDriver ì˜¤ë¥˜ ë°œìƒ (Step 2 - ì•ˆì‹¬ë²ˆí˜¸ ìƒíƒœ í™•ì¸)")
                     critical_exception(e, "ì•ˆì‹¬ë²ˆí˜¸ ìƒíƒœ í™•ì¸", i)
                # ì•ˆì‹¬ë²ˆí˜¸ ìƒíƒœ í™•ì¸ ì¤‘ ê·¸ ì™¸ ì˜ˆì™¸ ì²˜ë¦¬ (ErrorNotice í˜¸ì¶œ í›„ ë‹¤ìŒ í–‰ìœ¼ë¡œ)
                except Exception as e:
                    logging.error(f"í–‰ {i}: ì•ˆì‹¬ë²ˆí˜¸ ìƒíƒœ ê°’ í™•ì¸ ì‹¤íŒ¨ - {str(e)}", exc_info=True)
                    loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸numberStatusValue í™•ì¸ ì‹¤íŒ¨: {e}")
                    ErrorNotice(e, i)
                    continue # ë‹¤ìŒ í–‰ìœ¼ë¡œ

            # *** RPA_NUMBER ì›ë³¸ ë¡œì§ ì¢…ë£Œ ***

        # ë©”ì¸ ë£¨í”„ì˜ ìµœìƒìœ„ ì˜ˆì™¸ ì²˜ë¦¬ (critical_exception í˜¸ì¶œ)
        except (NoSuchWindowException, WebDriverException) as e:
            logging.error(f"í–‰ {i}: ë©”ì¸ ë£¨í”„ WebDriver ì˜¤ë¥˜ ë°œìƒ")
            critical_exception(e, "Main Loop Processing", i)
        except Exception as e:
            logging.error(f"í–‰ {i}: ë©”ì¸ ì²˜ë¦¬ ë£¨í”„ì—ì„œ ì•Œ ìˆ˜ ì—†ëŠ” ì˜ˆì™¸ ë°œìƒ - {str(e)}", exc_info=True)
            loggin('warning', f"Google Sheet [{i}]ë²ˆì§¸ ì‹ ê³  ê±´ / âš ï¸ Main forë¬¸ì—ì„œ, ì•Œ ìˆ˜ ì—†ëŠ” ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
            ErrorNotice(f"Main loop unknown error: {e}", i)
            continue # ë‹¤ìŒ í–‰ ì²˜ë¦¬

        # --- ë£¨í”„ ì¢…ë£Œ ì „ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ---
        SheetUpdatePost(i) # ê° í–‰ ì²˜ë¦¬ ì™„ë£Œ í›„ ì €ì¥ëœ ë‚´ìš© ì—…ë°ì´íŠ¸
        logging.info(f"===== í–‰ {i} ì²˜ë¦¬ ì™„ë£Œ =====")
        # --- ë£¨í”„ ê°„ ëŒ€ê¸° ì‹œê°„ (í•„ìš” ì‹œ) ---
        # time.sleep(1) # ì„œë²„ ë¶€í•˜ ê°ì†Œ ëª©ì  ë“±

    logging.info("main_task ì¢…ë£Œ: ëª¨ë“  í–‰ ì²˜ë¦¬ ì™„ë£Œ")


# --- ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜ (PROì™€ ë™ì¼ êµ¬ì¡°) ---
def main():
    global driver # ì „ì—­ driver ê°ì²´ ì‚¬ìš© ëª…ì‹œ
    try:
        logging.info("í”„ë¡œì„¸ìŠ¤ ì‹œì‘")
        Reset() # ì‹œíŠ¸ í™•ì¸ ë° ì‹œì‘/ì¢…ë£Œ ì…€ ì„¤ì •

        logging.info("ì›¹ë“œë¼ì´ë²„ ì´ˆê¸°í™” ì‹œì‘ (soomgo_login_util ì‚¬ìš©)")
        driver = get_soomgo_driver() # ë¡œê·¸ì¸ ë° ë“œë¼ì´ë²„ ê°ì²´ ì–»ê¸°

        if not driver:
            logging.error("WebDriver ì´ˆê¸°í™” ì‹¤íŒ¨, ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            try:
                SavedUpdateSheetValues(absCell_Status, "âš ï¸ RPA Error")
                SavedUpdateSheetValues(absCell_ETA, "Driver Init Failed")
                SheetUpdatePost(0)
            except Exception as sheet_err:
                 logging.error(f"ë“œë¼ì´ë²„ ì´ˆê¸°í™” ì‹¤íŒ¨ ìƒíƒœ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: {sheet_err}")
            sys.exit(1)

        logging.info("ì›¹ë“œë¼ì´ë²„ ì´ˆê¸°í™” ì™„ë£Œ")

        main_task() # í•µì‹¬ ì‘ì—… ìˆ˜í–‰

        logging.info("ëª¨ë“  ì‘ì—… ì²˜ë¦¬ ì™„ë£Œ")
        SavedUpdateSheetValues(absCell_Status, "âœ… RPA Complete")
        SavedUpdateSheetValues(absCell_ETA, "-")
        SavedUpdateSheetValues(absCell_Progress_Percent, "100.0%")
        SheetUpdatePost(global_endCell)

    except UnexpectedAlertPresentException as alert_e:
        logging.warning(f"ë©”ì¸ í”„ë¡œì„¸ìŠ¤ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ Alert ë°œìƒ: {alert_e}")
        try:
            alert = driver.switch_to.alert
            alert_text = alert.text
            logging.warning(f"Alert ë‚´ìš©: {alert_text}. Alertë¥¼ ë‹«ìŠµë‹ˆë‹¤.")
            alert.accept()
            raise Exception(f"Uncaught Alert: {alert_text}")
        except NoAlertPresentException:
            logging.error("UnexpectedAlertPresentException ë°œìƒí–ˆìœ¼ë‚˜ Alertë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ.", exc_info=True)
        except Exception as e_alert:
            logging.error(f"Alert ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e_alert}", exc_info=True)
            raise e_alert

    except Exception as e:
        logging.error(f"ë©”ì¸ í•¨ìˆ˜ì—ì„œ ì˜ˆì™¸ ë°œìƒ: {str(e)}", exc_info=True)
        try:
            SavedUpdateSheetValues(absCell_Status, "âš ï¸ RPA Error")
            SavedUpdateSheetValues(absCell_ETA, "Runtime Error")
            SheetUpdatePost(0)
        except Exception as sheet_err:
            logging.error(f"ë©”ì¸ ì˜¤ë¥˜ ìƒíƒœ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì¤‘ ì¶”ê°€ ì˜¤ë¥˜ ë°œìƒ: {sheet_err}")

    finally:
        if driver:
            try:
                logging.info("ë“œë¼ì´ë²„ ì¢…ë£Œ ì¤‘...")
                driver.quit()
                logging.info("ë“œë¼ì´ë²„ ì •ìƒ ì¢…ë£Œ")
            except Exception as quit_err:
                logging.warning(f"ë“œë¼ì´ë²„ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {quit_err}")
        logging.info("RPA ìŠ¤í¬ë¦½íŠ¸ ìµœì¢… ì¢…ë£Œ.")


# --- ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì§„ì…ì  (PROì™€ ë™ì¼ êµ¬ì¡°) ---
if __name__ == "__main__":
    try:
        logging.info("í”„ë¡œê·¸ë¨ ì‹œì‘ì  ì§„ì…")
        main()
        logging.info("í”„ë¡œê·¸ë¨ ì •ìƒ ì¢…ë£Œ (main í•¨ìˆ˜ ì™„ë£Œ)")
    except KeyboardInterrupt:
        logging.warning("í”„ë¡œê·¸ë¨ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤ (Ctrl+C).")
        loggin('warning', "í”„ë¡œê·¸ë¨ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
        try:
            SavedUpdateSheetValues(absCell_Status, "âš ï¸ RPA Interrupted")
            SavedUpdateSheetValues(absCell_ETA, "-")
            SheetUpdatePost(0)
            if driver:
                driver.quit()
        except Exception as final_err:
            logging.error(f"ê°•ì œ ì¢…ë£Œ ì‹œ í›„ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {final_err}")
        sys.exit(0)
    except Exception as e:
        logging.critical(f"ì˜ˆìƒì¹˜ ëª»í•œ ìµœìƒìœ„ ì˜¤ë¥˜ë¡œ í”„ë¡œê·¸ë¨ ë¹„ì •ìƒ ì¢…ë£Œ: {str(e)}", exc_info=True)
        try:
            SavedUpdateSheetValues(absCell_Status, "âš ï¸ RPA CRITICAL ERROR")
            SavedUpdateSheetValues(absCell_ETA, "-")
            SheetUpdatePost(0)
            if driver:
                driver.quit()
        except Exception as final_err:
            logging.error(f"ìµœìƒìœ„ ì˜¤ë¥˜ ë°œìƒ ì‹œ í›„ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {final_err}")
        sys.exit(1)

